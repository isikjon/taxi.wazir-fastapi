<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞ –ª–∏–Ω–∏–∏ - WAZIR</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/driver/assets/scss/main.css') }}">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
        .online-map {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .online-status {
            text-align: center;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .online-status.offline {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .order-notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            display: none;
        }

        .order-notification.show {
            transform: translateY(0);
            display: block;
        }

        .navigation-panel {
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .navigation-panel.active {
            display: block;
        }

        .btn-online {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-accept {
            background: #27ae60;
            color: white;
        }

        .btn-decline {
            background: #e74c3c;
            color: white;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .earnings-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
            margin: 15px 0;
        }

        .status-text {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body data-driver-id="{{ driver_id }}">
    <main>
        <section class="profile">
            <div class="container">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="profile__header">
                    <div class="profile__back">
                        <a href="/driver/profile">
                            <img src="{{ url_for('static', path='/driver/assets/img/ico/back.svg') }}" alt="back">
                        </a>
                    </div>
                    <h1 class="title">–ù–∞ –ª–∏–Ω–∏–∏</h1>
                    <div class="profile__settings">
                        <button onclick="goOffline()">
                            <img src="{{ url_for('static', path='/driver/assets/img/ico/close.svg') }}" alt="close">
                        </button>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è -->
                <div class="online-status" id="driverStatus">
                    <h2>üü¢ –í—ã –Ω–∞ –ª–∏–Ω–∏–∏</h2>
                    <p>–ò—â–µ–º –∑–∞–∫–∞–∑—ã –¥–ª—è –≤–∞—Å...</p>
                </div>

                <!-- –ó–∞—Ä–∞–±–æ—Ç–æ–∫ -->
                <div class="earnings-display" id="earningsDisplay">
                    0 —Å–æ–º
                </div>

                <!-- –ö–∞—Ä—Ç–∞ -->
                <div class="online-map" id="mapContainer">
                    <div id="map" style="width: 100%; height: 100%;"></div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞ -->
                <div class="status-text" id="statusText">
                    üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="navigation-panel" id="navigationPanel">
                    <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                    <div id="routeInfo">
                        <p><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="tripDistance">-</span></p>
                        <p><strong>–í—Ä–µ–º—è:</strong> <span id="tripDuration">-</span></p>
                    </div>
                    <div id="instruction" style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <span id="instructionText">–û–∂–∏–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</span>
                    </div>
                    <button class="btn-online btn-decline" onclick="cancelTrip()">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="profile__actions" id="controlButtons">
                    <button class="btn-online btn-primary" onclick="startTrip()" id="startTripBtn" style="display:none;">
                        –ù–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É
                    </button>
                    <button class="btn-online btn-accept" onclick="completeTrip()" id="completeTripBtn" style="display:none;">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É
                    </button>
                    <button class="btn-online btn-decline" onclick="goOffline()">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ -->
    <div class="order-notification" id="orderNotification">
        <h3>üöó –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
        <div style="margin: 15px 0;">
            <p><strong>–û—Ç–∫—É–¥–∞:</strong> <span id="orderOrigin">-</span></p>
            <p><strong>–ö—É–¥–∞:</strong> <span id="orderDestination">-</span></p>
            <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="orderPrice">-</span></p>
            <p><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="orderDistance">-</span></p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-online btn-accept" onclick="acceptOrder()" style="flex: 1;">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="btn-online btn-decline" onclick="declineOrder()" style="flex: 1;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let currentOrder = null;
        let driverId = parseInt('{{ driver_id|default(1) }}') || 1;
        let isOnline = true;
        let currentLocation = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ù–∞ –ª–∏–Ω–∏–∏" –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üë§ ID –≤–æ–¥–∏—Ç–µ–ª—è:', driverId);
            
            // –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Google Maps
            waitForGoogleMaps();
        });

        function waitForGoogleMaps() {
            if (window.google && window.google.maps) {
                initMap();
            } else {
                console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Google Maps API...');
                setTimeout(waitForGoogleMaps, 500);
            }
        }

        function initMap() {
            console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
            
            const oshCenter = { lat: 40.5138, lng: 72.8019 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: oshCenter,
                zoom: 15,
                gestureHandling: 'greedy',
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#3498db',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });
            directionsRenderer.setMap(map);

            getCurrentLocation();
            startOrderPolling();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(currentLocation);
                        
                        new google.maps.Marker({
                            position: currentLocation,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#3498db',
                                fillOpacity: 1,
                                strokeColor: '#fff',
                                strokeWeight: 3
                            },
                            title: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
                        });
                        
                        console.log('üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞');
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                        currentLocation = { lat: 40.5138, lng: 72.8019 };
                    }
                );
            }
        }

        function startOrderPolling() {
            if (!isOnline) return;
            
            fetch(`/api/driver/${driverId}/new-orders`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.orders.length > 0) {
                        console.log('üì± –ù–æ–≤—ã–π –∑–∞–∫–∞–∑:', data.orders[0]);
                        showOrderNotification(data.orders[0]);
                    } else {
                        updateStatus('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                });
            
            setTimeout(startOrderPolling, 5000);
        }

        function showOrderNotification(order) {
            currentOrder = order;
            
            document.getElementById('orderOrigin').textContent = order.origin;
            document.getElementById('orderDestination').textContent = order.destination;
            document.getElementById('orderPrice').textContent = order.price ? `${order.price} —Å–æ–º` : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
            
            calculateRoute(order.origin, order.destination, (distance) => {
                document.getElementById('orderDistance').textContent = distance;
            });
            
            document.getElementById('orderNotification').classList.add('show');
            updateStatus('üì± –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!');
        }

        function acceptOrder() {
            if (!currentOrder) return;
            
            fetch(`/api/driver/${driverId}/accept-order/${currentOrder.id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç');
                    document.getElementById('orderNotification').classList.remove('show');
                    showNavigation(currentOrder);
                    updateStatus('üöó –ï–¥–µ–º –∫ –∫–ª–∏–µ–Ω—Ç—É');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            });
        }

        function declineOrder() {
            document.getElementById('orderNotification').classList.remove('show');
            currentOrder = null;
            updateStatus('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
        }

        function showNavigation(order) {
            document.getElementById('navigationPanel').classList.add('active');
            document.getElementById('startTripBtn').style.display = 'block';
            buildRoute(currentLocation, order.origin);
        }

        function buildRoute(from, to) {
            const origin = typeof from === 'string' ? from + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω' : from;
            const destination = typeof to === 'string' ? to + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω' : to;
            
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                    
                    const route = response.routes[0];
                    const leg = route.legs[0];
                    
                    document.getElementById('tripDistance').textContent = leg.distance.text;
                    document.getElementById('tripDuration').textContent = leg.duration.text;
                    
                    if (leg.steps.length > 0) {
                        const instruction = leg.steps[0].instructions.replace(/<[^>]*>/g, '');
                        document.getElementById('instructionText').textContent = instruction;
                    }
                    
                    console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω');
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞:', status);
                }
            });
        }

        function calculateRoute(origin, destination, callback) {
            const service = new google.maps.DirectionsService();
            service.route({
                origin: origin + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
                destination: destination + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    const route = response.routes[0];
                    const leg = route.legs[0];
                    callback(leg.distance.text);
                } else {
                    callback('~5 –∫–º');
                }
            });
        }

        function startTrip() {
            if (!currentOrder) return;
            
            fetch(`/api/driver/${driverId}/start-trip/${currentOrder.id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üöó –ü–æ–µ–∑–¥–∫–∞ –Ω–∞—á–∞—Ç–∞');
                    document.getElementById('startTripBtn').style.display = 'none';
                    document.getElementById('completeTripBtn').style.display = 'block';
                    updateStatus('üõ£Ô∏è –í –ø–æ–µ–∑–¥–∫–µ');
                    buildRoute(currentOrder.origin, currentOrder.destination);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        }

        function completeTrip() {
            document.getElementById('navigationPanel').classList.remove('active');
            document.getElementById('completeTripBtn').style.display = 'none';
            currentOrder = null;
            updateStatus('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
            directionsRenderer.setDirections({routes: []});
        }

        function cancelTrip() {
            document.getElementById('navigationPanel').classList.remove('active');
            document.getElementById('startTripBtn').style.display = 'none';
            document.getElementById('completeTripBtn').style.display = 'none';
            currentOrder = null;
            updateStatus('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
            directionsRenderer.setDirections({routes: []});
        }

        function updateStatus(status) {
            document.getElementById('statusText').innerHTML = status;
        }

        function goOffline() {
            isOnline = false;
            document.getElementById('driverStatus').innerHTML = '<h2>üî¥ –ù–µ –Ω–∞ –ª–∏–Ω–∏–∏</h2><p>–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</p>';
            document.getElementById('driverStatus').classList.add('offline');
            updateStatus('üõë –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            
            setTimeout(() => {
                window.location.href = '/driver/profile';
            }, 2000);
        }
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key|default('') }}&libraries=places&loading=async"></script>
</body>
</html> 