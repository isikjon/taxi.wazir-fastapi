<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞ –ª–∏–Ω–∏–∏ - WAZIR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .driver-status {
            background: #27ae60;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .driver-status.offline {
            background: #e74c3c;
        }

        .earnings {
            font-size: 18px;
            font-weight: bold;
            color: #f1c40f;
        }

        .map-container {
            position: relative;
            height: calc(100vh - 80px);
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .navigation-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            border-radius: 15px;
            padding: 20px;
            z-index: 100;
            display: none;
        }

        .navigation-panel.active {
            display: block;
        }

        .trip-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .distance-time {
            color: #27ae60;
            font-size: 18px;
            font-weight: bold;
        }

        .next-instruction {
            background: #2c3e50;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .instruction-icon {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            vertical-align: middle;
        }

        .instruction-text {
            font-size: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        .order-notification {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border-radius: 15px;
            padding: 20px;
            z-index: 200;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            display: none;
        }

        .order-notification.show {
            transform: translateY(0);
            display: block;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-title {
            font-size: 18px;
            font-weight: bold;
        }

        .order-price {
            font-size: 20px;
            font-weight: bold;
            color: #f1c40f;
        }

        .order-details {
            margin-bottom: 20px;
        }

        .route-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .order-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-accept {
            background: #27ae60;
            color: white;
        }

        .btn-accept:hover {
            background: #219a52;
        }

        .btn-decline {
            background: #e74c3c;
            color: white;
        }

        .btn-decline:hover {
            background: #c0392b;
        }

        .control-buttons {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .control-btn {
            flex: 1;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .control-btn:hover {
            background: #2980b9;
        }

        .control-btn.danger {
            background: #e74c3c;
        }

        .control-btn.danger:hover {
            background: #c0392b;
        }

        .control-btn.success {
            background: #27ae60;
        }

        .control-btn.success:hover {
            background: #219a52;
        }

        .status-indicator {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="driver-status" id="statusIndicator">üü¢ –ù–∞ –ª–∏–Ω–∏–∏</div>
            <div class="earnings" id="earningsDisplay">0 —Å–æ–º</div>
        </div>
        <div class="header-right">
            <button class="btn btn-decline" onclick="goOffline()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</button>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="order-notification" id="orderNotification">
            <div class="order-header">
                <div class="order-title">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</div>
                <div class="order-price" id="orderPrice">120 —Å–æ–º</div>
            </div>
            <div class="order-details">
                <div class="route-info">
                    <div><strong>–û—Ç–∫—É–¥–∞:</strong> <span id="orderOrigin">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –û—à–ì–£</span></div>
                    <div><strong>–ö—É–¥–∞:</strong> <span id="orderDestination">–û—à –ë–∞–∑–∞—Ä</span></div>
                    <div><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="orderDistance">5.2 –∫–º</span></div>
                    <div><strong>–í—Ä–µ–º—è:</strong> <span id="orderTime">~12 –º–∏–Ω</span></div>
                </div>
            </div>
            <div class="order-actions">
                <button class="btn btn-accept" onclick="acceptOrder()">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="btn btn-decline" onclick="declineOrder()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="navigation-panel" id="navigationPanel">
            <div class="trip-info">
                <div class="distance-time" id="tripInfo">5.2 –∫–º ‚Ä¢ 12 –º–∏–Ω</div>
                <button class="btn btn-decline" onclick="cancelTrip()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="next-instruction">
                <div class="instruction-icon">‚Üí</div>
                <div class="instruction-text" id="instructionText">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ —á–µ—Ä–µ–∑ 500 –º</div>
            </div>
        </div>

        <div class="status-indicator" id="statusDisplay">
            <div>üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>

        <div class="control-buttons" id="controlButtons">
            <button class="control-btn" onclick="startTrip()" id="startTripBtn" style="display:none;">–ù–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
            <button class="control-btn success" onclick="completeTrip()" id="completeTripBtn" style="display:none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let currentOrder = null;
        let driverId = parseInt('{{ driver_id|default(1) }}') || 1;
        let isOnline = true;
        let currentLocation = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è...');
            
            // –¶–µ–Ω—Ç—Ä –û—à
            const oshCenter = { lat: 40.5138, lng: 72.8019 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: oshCenter,
                zoom: 15,
                gestureHandling: 'greedy',
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#1a1a1a"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry",
                        "stylers": [{"color": "#2c3e50"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [{"color": "#3498db"}]
                    }
                ]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#27ae60',
                    strokeWeight: 6,
                    strokeOpacity: 0.8
                }
            });
            directionsRenderer.setMap(map);

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            getCurrentLocation();
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤
            startOrderPolling();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(currentLocation);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                        new google.maps.Marker({
                            position: currentLocation,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#3498db',
                                fillOpacity: 1,
                                strokeColor: '#fff',
                                strokeWeight: 3
                            },
                            title: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
                        });
                        
                        console.log('üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:', currentLocation);
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –û—à –∫–∞–∫ fallback
                        currentLocation = { lat: 40.5138, lng: 72.8019 };
                    }
                );
            }
        }

        // –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        function startOrderPolling() {
            if (!isOnline) return;
            
            fetch(`/api/driver/${driverId}/new-orders`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.orders.length > 0) {
                        console.log('üì± –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑:', data.orders[0]);
                        showOrderNotification(data.orders[0]);
                    } else {
                        console.log('üîç –ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç');
                        updateStatusDisplay('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:', error);
                });
            
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(startOrderPolling, 5000);
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
        function showOrderNotification(order) {
            currentOrder = order;
            
            document.getElementById('orderPrice').textContent = order.price ? `${order.price} —Å–æ–º` : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
            document.getElementById('orderOrigin').textContent = order.origin;
            document.getElementById('orderDestination').textContent = order.destination;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—Ä–µ–º—è
            calculateRoute(order.origin, order.destination, (distance, duration) => {
                document.getElementById('orderDistance').textContent = distance;
                document.getElementById('orderTime').textContent = duration;
            });
            
            document.getElementById('orderNotification').classList.add('show');
            updateStatusDisplay('üì± –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!');
        }

        // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞
        function acceptOrder() {
            if (!currentOrder) return;
            
            fetch(`/api/driver/${driverId}/accept-order/${currentOrder.id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç:', data.order);
                    document.getElementById('orderNotification').classList.remove('show');
                    showNavigation(currentOrder);
                    updateStatusDisplay('üöó –ï–¥–µ–º –∫ –∫–ª–∏–µ–Ω—Ç—É');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }

        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        function declineOrder() {
            document.getElementById('orderNotification').classList.remove('show');
            currentOrder = null;
            updateStatusDisplay('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
        }

        // –ü–æ–∫–∞–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function showNavigation(order) {
            document.getElementById('navigationPanel').classList.add('active');
            document.getElementById('startTripBtn').style.display = 'block';
            
            // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –∫ –∫–ª–∏–µ–Ω—Ç—É
            buildRoute(currentLocation, order.origin);
        }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function buildRoute(from, to) {
            const origin = typeof from === 'string' ? from + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω' : from;
            const destination = typeof to === 'string' ? to + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω' : to;
            
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                    
                    const route = response.routes[0];
                    const leg = route.legs[0];
                    
                    document.getElementById('tripInfo').textContent = 
                        `${leg.distance.text} ‚Ä¢ ${leg.duration.text}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                    if (leg.steps.length > 0) {
                        updateInstruction(leg.steps[0]);
                    }
                    
                    console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω');
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', status);
                }
            });
        }

        // –†–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
        function calculateRoute(origin, destination, callback) {
            const service = new google.maps.DirectionsService();
            service.route({
                origin: origin + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
                destination: destination + ', –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    const route = response.routes[0];
                    const leg = route.legs[0];
                    callback(leg.distance.text, leg.duration.text);
                } else {
                    callback('~5 –∫–º', '~12 –º–∏–Ω');
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function updateInstruction(step) {
            const instruction = step.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('instructionText').textContent = instruction;
        }

        // –ù–∞—á–∞–ª–æ –ø–æ–µ–∑–¥–∫–∏
        function startTrip() {
            if (!currentOrder) return;
            
            fetch(`/api/driver/${driverId}/start-trip/${currentOrder.id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üöó –ü–æ–µ–∑–¥–∫–∞ –Ω–∞—á–∞—Ç–∞');
                    document.getElementById('startTripBtn').style.display = 'none';
                    document.getElementById('completeTripBtn').style.display = 'block';
                    updateStatusDisplay('üõ£Ô∏è –í –ø–æ–µ–∑–¥–∫–µ');
                    
                    // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –∫ –ø—É–Ω–∫—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                    buildRoute(currentOrder.origin, currentOrder.destination);
                } else {
                    alert('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–µ–∑–¥–∫–∏: ' + data.error);
                }
            });
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏
        function completeTrip() {
            document.getElementById('navigationPanel').classList.remove('active');
            document.getElementById('completeTripBtn').style.display = 'none';
            currentOrder = null;
            updateStatusDisplay('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
            
            // –û—á–∏—â–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
            directionsRenderer.setDirections({routes: []});
        }

        // –û—Ç–º–µ–Ω–∞ –ø–æ–µ–∑–¥–∫–∏
        function cancelTrip() {
            document.getElementById('navigationPanel').classList.remove('active');
            document.getElementById('startTripBtn').style.display = 'none';
            document.getElementById('completeTripBtn').style.display = 'none';
            currentOrder = null;
            updateStatusDisplay('üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...');
            
            // –û—á–∏—â–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
            directionsRenderer.setDirections({routes: []});
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatusDisplay(status) {
            document.getElementById('statusDisplay').innerHTML = `<div>${status}</div>`;
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–º–µ–Ω—ã
        function goOffline() {
            isOnline = false;
            document.getElementById('statusIndicator').textContent = 'üî¥ –ù–µ –Ω–∞ –ª–∏–Ω–∏–∏';
            document.getElementById('statusIndicator').classList.add('offline');
            updateStatusDisplay('üõë –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ–¥–∏—Ç–µ–ª—è
            window.location.href = '/driver/';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–¥–∏—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üë§ ID –≤–æ–¥–∏—Ç–µ–ª—è:', driverId);
        };
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key|default('') }}&libraries=places&loading=async&callback=initMap"></script>
</body>
</html> 