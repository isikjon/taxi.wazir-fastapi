<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Wazir.kg</title>
        <link rel="stylesheet"
            href="{{ url_for('static', path='/driver/assets/scss/main.css') }}">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
        <style>
            /* –£–±–∏—Ä–∞–µ–º border-radius —É –∫–Ω–æ–ø–æ–∫ */
            .main__btn, button {
                border-radius: 0px !important;
            }
            
            /* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
            .spinner {
                display: none;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .btn-with-spinner {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="brand">
                <div class="container">
                    <div class="brand__content">
                        <div class="logo">
                            <a href="{{ url_for('user_auth_step1') }}">
                                <img
                                    src="{{ url_for('static', path='/driver/assets/img/logo.png') }}"
                                    alt="logo">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <section class="register">
                <div class="container">
                    <div class="register__content">
                        <div class="register__intro">
                            <h1 class="title">
                                –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ —Å–º—Å. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –µ–≥–æ –Ω–∞ –Ω–æ–º–µ—Ä
                                <span class="active-phone-number">{{ phone
                                    }}</span>
                            </h1>
                        </div>
                        <div class="register__form">
                            <form id="smsForm">
                                <div class="sms-code-wrapper">
                                    <input type="text" maxlength="1"
                                        class="sms-code">
                                    <input type="text" maxlength="1"
                                        class="sms-code">
                                    <input type="text" maxlength="1"
                                        class="sms-code">
                                    <input type="text" maxlength="1"
                                        class="sms-code">
                                </div>
                                <p class="timer-sms">–ö–æ–¥ –Ω–µ –ø—Ä–∏—à–µ–ª</p>
                                <p class="invalid-text">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</p>
                                <button class="resend-sms btn-with-spinner" type="button">
                                    <span class="btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</span>
                                    <div class="spinner"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function () {
                const urlParams = new URLSearchParams(window.location.search);
                const phoneNumber = urlParams.get('phone');
                
                // –ë–µ—Ä–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ URL –∏–ª–∏ –∏–∑ localStorage
                let phoneToUse;
                if (phoneNumber) {
                    phoneToUse = decodeURIComponent(phoneNumber);
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å +
                    if (!phoneToUse.startsWith('+')) {
                        phoneToUse = '+' + phoneToUse;
                    }
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –Ω–∞ —Å–ª—É—á–∞–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    localStorage.setItem('user_phone', phoneToUse);
                    console.log('–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω –∏–∑ URL –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage:', phoneToUse);
                } else {
                    // –ï—Å–ª–∏ –≤ URL –Ω–µ—Ç, –±–µ—Ä–µ–º –∏–∑ localStorage
                    phoneToUse = localStorage.getItem('user_phone');
                    console.log('–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω –∏–∑ localStorage:', phoneToUse);
                }

                if (phoneToUse) {
                    $('.active-phone-number').text(phoneToUse);
                }

                const $smsInputs = $('.sms-code');

                $smsInputs.on('input', function (e) {
                    const $this = $(this);

                    this.value = this.value.replace(/[^\d]/g, '');

                    if (this.value.length === 1) {
                        $this.next('.sms-code').focus();
                    }

                    if ($smsInputs.last().is($this)) {
                        validateCode();
                    }
                });

                $smsInputs.on('keydown', function (e) {
                    const $this = $(this);

                    if (e.keyCode === 8 && !this.value) {
                        $this.prev('.sms-code').focus();
                    }
                });

                let timeLeft = 59;
                const timerElement = $('.timer-sms');
                const resendLink = $('.resend-sms');
                const invalidText = $('.invalid-text');
                const $form = $('.register__form form');

                resendLink.hide();
                invalidText.hide();

                function startTimer() {
                    const timer = setInterval(function () {
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            timerElement.hide();
                            resendLink.show();
                        } else {
                            timerElement.text(`–ö–æ–¥ –Ω–µ –ø—Ä–∏—à–µ–ª (0:${timeLeft.toString().padStart(2, '0')})`);
                            timeLeft--;
                        }
                    }, 1000);
                }

                function validateCode() {
                    const enteredCode = Array.from($smsInputs).map(input => input.value).join('');
                    const phone = $('.active-phone-number').text() || localStorage.getItem('user_phone');
                    
                    // –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ–º –∫–æ–¥ 1111
                    if (enteredCode === '1111') {
                        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å +
                        let formattedPhone = phone;
                        if (!formattedPhone.startsWith('+')) {
                            formattedPhone = '+' + formattedPhone;
                        }
                        
                        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —Ç–µ–ª–µ—Ñ–æ–Ω:', formattedPhone, '–∫–æ–¥:', enteredCode);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
                        $.ajax({
                            url: '/api/user/verify-code',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ 
                                phone: formattedPhone,
                                code: enteredCode 
                            }),
                            success: function(response) {
                                // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
                                console.log('API –æ—Ç–≤–µ—Ç:', response);
                                console.log('has_profile:', response.has_profile);
                                console.log('üì± –¢–µ–∫—É—â–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ localStorage:', localStorage.getItem('user_phone'));
                                console.log('üìã –°–æ—Å—Ç–æ—è–Ω–∏–µ localStorage –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:', {
                                    keys: Object.keys(localStorage),
                                    user_phone: localStorage.getItem('user_phone')
                                });
                                
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                                localStorage.setItem('user_access_token', response.access_token);
                                localStorage.setItem('user_id', response.user_id);
                                localStorage.setItem('user_phone', formattedPhone);
                                
                                console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage:', {
                                    user_access_token: response.access_token,
                                    user_id: response.user_id,
                                    user_phone: formattedPhone
                                });
                                
                                console.log('–£—Å–ø–µ—à–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', {
                                    user_id: response.user_id,
                                    access_token: response.access_token,
                                    has_profile: response.has_profile
                                });
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–Ω–∫–µ—Ç–∞
                                console.log('–¢–∏–ø has_profile:', typeof response.has_profile);
                                console.log('–ó–Ω–∞—á–µ–Ω–∏–µ has_profile:', response.has_profile);
                                
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ undefined/null
                                if (response.has_profile === true) {
                                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é');
                                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    window.location.href = '/user/profile';
                                } else if (response.has_profile === false) {
                                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª –ø—Ä–æ—Ñ–∏–ª—å, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö');
                                    // –ï—Å–ª–∏ –Ω–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                                    window.location.href = '/user/auth/3';
                                } else {
                                    console.log('has_profile –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω');
                                    // –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
                                    window.location.href = '/user/auth/3';
                                }
                            },
                            error: function(xhr) {
                                $form.addClass('invalid');
                                invalidText.show();
                                resendLink.show();
                            }
                        });
                    } else if (enteredCode.length === 4) {
                        // –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥
                        $form.addClass('invalid');
                        invalidText.show();
                        resendLink.show();
                    }
                }

                resendLink.on('click', function (e) {
                    e.preventDefault();
                    const phone = $('.active-phone-number').text() || localStorage.getItem('user_phone');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
                    const $btn = $(this);
                    const $btnText = $btn.find('.btn-text');
                    const $spinner = $btn.find('.spinner');
                    
                    $spinner.show();
                    $btnText.text('–û—Ç–ø—Ä–∞–≤–∫–∞...');
                    $btn.prop('disabled', true);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–¥–∞
                    $.ajax({
                        url: '/api/user/login',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ phone: phone }),
                        success: function() {
                            timeLeft = 59;
                            resendLink.hide();
                            timerElement.show();
                            $form.removeClass('invalid');
                            $smsInputs.val('');
                            $smsInputs.first().focus();
                            invalidText.hide();
                            startTimer();
                        },
                        error: function(xhr) {
                            console.error('–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:', xhr);
                            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                            $spinner.hide();
                            $btnText.text('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ');
                            $btn.prop('disabled', false);
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                    });
                });

                startTimer();

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫
                function showError(message) {
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if (!$('#error-message').length) {
                        $('<div>').attr('id', 'error-message')
                            .css({
                                'color': 'red',
                                'margin-bottom': '15px',
                                'text-align': 'center'
                            })
                            .insertBefore($('#verifyForm'));
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    $('#error-message').text(message).show();
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        $('#error-message').hide();
                    }, 3000);
                }
            });
        </script>
    </body>
</html>
