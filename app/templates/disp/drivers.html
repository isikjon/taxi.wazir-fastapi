{% extends "base.html" %}

{% block title %}Водители - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<!-- <div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="Поиск" id="header-search"
                value="{{ search|default('') }}">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div> -->
{% endblock %}

{% block subheader %}
<div class="main__subheader main__subheader-drivers">
    <div class="main__subheader-add">
        <div class="main__header-search-item">
            <form action="{{ url_for('disp_drivers') }}" method="GET" style="background-color: #47484c;">
                <input type="search" name="search" id="driver-search" placeholder="Поиск"
                    value="{% if search and search != 'None' %}{{ search }}{% endif %}">
                <button type="submit" style="padding: 0px;"><img
                        src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                        alt="search"></button>
            </form>
        </div>
        <div class="main__subheader-filing">
            <select name="status" id="status-filter" onchange="applyFilters()">
                <option value="" {% if not status or status == "None" %}selected{% endif %}>Статусы</option>
                <option value="Занят" {% if status == "Занят" %}selected{% endif %}>Занят</option>
                <option value="Свободен" {% if status == "Свободен" %}selected{% endif %}>Свободен</option>
            </select>
        </div>
        <!-- <div class="main__subheader-filing">
            <select name="state" id="state-filter" onchange="applyFilters()">
                <option value="" {% if not state or state == "None" %}selected{% endif %}>Состояние</option>
                <option value="Работает" {% if state == "Работает" %}selected{% endif %}>Работает</option>
                <option value="Не работает" {% if state == "Не работает" %}selected{% endif %}>Не работает</option>
            </select>
        </div> -->
        {% if is_filtered %}
        <div class="main__subheader-filing">
            <a href="{{ url_for('disp_drivers') }}"
                class="main__btn-short">Сбросить фильтры</a>
        </div>
        {% endif %}
    </div>
    <div class="main__subheader-drivers">
        <!-- <div class="main__header-tags main__subheader-drivers-tags">
            <ul>
                <li>На линии {{ total_drivers|default('0') }} водителей</li>
                <li><span class="status-span free"></span> {{
                    available_drivers|default('0') }}
                    свободный</li>
                <li><span class="status-span busy"></span> {{
                    busy_drivers|default('0') }}
                    занят</li>
            </ul>
        </div> -->
        <div class="main__subheader-balance">
            <img
                src="{{ url_for('static', path='/assets/img/ico/balance.png') }}"
                alt="balance">
            <p>
                Баланс: {{ total_balance|default('0') }}
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__drivers-table">
    <div class="main__table main__paybalance-table">
        <table>
            <thead>
                <tr>
                    <th>Состояние</th>
                    <th>Позывной</th>
                    <th>Ф.И.О</th>
                    <th>Телефон</th>
                    <th>Баланс</th>
                    <th>Лимит</th>
                    <th>ВУ</th>
                    <th>Уникальный ID</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="drivers-table-body">
                {% if drivers %}
                {% for driver in drivers %}
                <tr class="driver-row" data-id="{{ driver.id }}">
                    <td class="status">
                        <span
                            class="status-{{ 'busy' if driver.is_busy|default(False) else 'free' }}">{{
                            'Занят' if driver.is_busy|default(False) else
                            'Свободен' }}</span>
                    </td>
                    <td>{{ driver.callsign }}</td>
                    <td>{{ driver.full_name }}</td>
                    <td>{{ driver.phone|default('+996 XXX XX-XX-XX') }}</td>
                    <td>{{ driver.balance }}</td>
                    <td>{{ driver.limit|default(driver.balance) }}</td>
                    <td>{{ driver.driver_license_number }}</td>
                    <td>{{ driver.unique_id }}</td>
                    <td>
                        <button class="main__btn-short delete-driver"
                            data-id="{{ driver.id }}">Удалить</button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" class="no-data">
                        <div class="empty-state">
                            <img
                                src="https://wazir.kg/static/search.png"
                                alt="Нет водителей" style="max-width: 24px;">
                            <p>{% if is_filtered %}Нет водителей, соответствующих заданным критериям{% else %}Нет доступных водителей{% endif %}</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="main__table-footer">
            <div class="main__table-driver">
                <button>Водители: {{ total_drivers|default('0') }}</button>
                <button>Баланс: {{ total_balance|default('0') }}</button>
            </div>
            <div class="main__table-pagination">
                <div class="main__table-pagination-prev">
                    <button {% if page == 1 %}disabled{% endif %}><img
                            src="{{ url_for('static', path='/assets/img/ico/prev.png') }}"
                            alt="prev"></button>
                </div>
                {% for p in range(1, total_pages + 1) %}
                <div
                    class="main__table-pagination-{% if p == page %}active{% endif %} main__table-pagination-item">
                    <button>{{ p }}</button>
                </div>
                {% endfor %}
                <div class="main__table-pagination-next">
                    <button {% if page == total_pages %}disabled{% endif %}><img
                            src="{{ url_for('static', path='/assets/img/ico/next.png') }}"
                            alt="next"></button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .main__table td, .main__paybalance-table td {
        display: table-cell !important;
        align-items: normal !important;
        vertical-align: middle;
        text-align: left;
        padding: 10px;
    }
    
    .status {
        align-items: initial !important;
    }
    
    .main__table th, .main__paybalance-table th {
        text-align: left;
        padding: 10px;
    }
    
    .main__table tr, .main__paybalance-table tr {
        display: table-row !important;
    }
    
    .main__table tbody, .main__paybalance-table tbody {
        display: table-row-group !important;
    }
</style>
<script>
    // Функция для применения фильтров через перезагрузку страницы
    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        
        // Получаем текущее значение поиска
        const searchValue = $('#driver-search').val();
        if (searchValue && searchValue.trim() !== '') {
            params.set('search', searchValue.trim());
        } else {
            params.delete('search');
        }
        
        // Получаем значение статуса
        const statusValue = $('#status-filter').val();
        if (statusValue && statusValue !== '') {
            params.set('status', statusValue);
        } else {
            params.delete('status');
        }
        
        // Получаем значение состояния
        const stateValue = $('#state-filter').val();
        if (stateValue && stateValue !== '') {
            params.set('state', stateValue);
        } else {
            params.delete('state');
        }
        
        // Перезагружаем страницу с новыми параметрами
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    }
    
    $(document).ready(function() {
        
        // Обработка пагинации
        $('.main__table-pagination-item button').click(function() {
            const page = $(this).text();
            const params = new URLSearchParams(window.location.search);
            params.set('page', page);
            window.location.href = window.location.pathname + '?' + params.toString();
        });
        
        $('.main__table-pagination-prev button').click(function() {
            if (!$(this).prop('disabled')) {
                const currentPage = parseInt($('.main__table-pagination-active button').text());
                const params = new URLSearchParams(window.location.search);
                params.set('page', currentPage - 1);
                window.location.href = window.location.pathname + '?' + params.toString();
            }
        });
        
        $('.main__table-pagination-next button').click(function() {
            if (!$(this).prop('disabled')) {
                const currentPage = parseInt($('.main__table-pagination-active button').text());
                const params = new URLSearchParams(window.location.search);
                params.set('page', currentPage + 1);
                window.location.href = window.location.pathname + '?' + params.toString();
            }
        });
        
        // Обработка удаления водителя
        $('.delete-driver').click(function() {
            const driverId = $(this).data('id');
            if (confirm('Вы уверены, что хотите удалить этого водителя?')) {
                // Отправляем AJAX запрос на удаление водителя
                $.ajax({
                    url: `/api/drivers/${driverId}`,
                    type: 'DELETE',
                    success: function(result) {
                        // Удаляем строку из таблицы
                        $(`.driver-row[data-id="${driverId}"]`).remove();
                        
                        // Обновляем счетчики
                        const totalDrivers = $('.driver-row').length;
                        const availableDrivers = $('.status-free').length;
                        const busyDrivers = $('.status-busy').length;
                        
                        // Обновляем информацию в интерфейсе
                        $('li:contains("На линии")').text(`На линии ${totalDrivers} водителей`);
                        $('li:contains("свободный")').html(`<span class="status-span free"></span> ${availableDrivers} свободный`);
                        $('li:contains("занят")').html(`<span class="status-span busy"></span> ${busyDrivers} занят`);
                        
                        // Если водителей не осталось, показываем сообщение о пустой таблице
                        if (totalDrivers === 0) {
                            $('#drivers-table-body').html(`
                                <tr>
                                    <td colspan="9" class="no-data">
                                        <div class="empty-state">
                                            <img src="${$('meta[name="base-url"]').attr('content')}/static/assets/img/ico/user.png" alt="Нет водителей">
                                            <p>Нет доступных водителей</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                        }
                        
                        alert('Водитель успешно удален');
                    },
                    error: function(xhr, status, error) {
                        alert('Произошла ошибка при удалении водителя: ' + error);
                    }
                });
            }
        });
    });
</script>
{% endblock %}