{% extends "base.html" %}

{% block title %}Новый заказ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="Поиск">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>Заказ №</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Дата время</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Путевой лист</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>Выберите водителя</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>Вариант</option>
                                <option value="Эконом">Эконом</option>
                                <option value="Комфорт">Комфорт</option>
                                <option value="Комфорт+">Комфорт+</option>
                                <option value="Бизнес">Бизнес</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>Оплата</option>
                                <option value="Наличные">Наличные</option>
                                <option value="На карту">На карту</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="Откуда (адрес отправления)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="Куда (адрес назначения)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="Примечание"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">Заказ другому человеку</button>
                        <button type="button" class="main__btn-short">Дополнительные услуги</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Заказ</th>
                                <th>Время</th>
                                <th>Откуда</th>
                                <th>Куда</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">Нет данных о последних заказах</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map"></div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">Данные для рассчета</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">Очистить маркеры</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="Эконом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="Посадка: 48 сом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="Расстояние: 0 км">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="Время в пути: 0 мин">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="Стоимость: 0 сом">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">Заказать</button>
            <button type="button" id="cancel-btn" class="main__btn">Отменить</button>
        </div>
    </form>
</div>

<!-- Загрузка Google Maps JS API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api }}&libraries=places"></script>
<script>
    let map;
    let firstMarker = null;
    let secondMarker = null;
    let selecting = 'a';
    let directionsService;
    let directionsRenderer;
    let geocoder;

    const OSH = { lat: 40.5138, lng: 72.8019 };

    const TARIFFS = {
        'Эконом': { boardingFee: 50, cityPricePerKm: 15, cityPricePerMinute: 0.5, minimumPrice: 50 },
        'Комфорт': { boardingFee: 80, cityPricePerKm: 20, cityPricePerMinute: 0.8, minimumPrice: 80 },
        'Комфорт+': { boardingFee: 100, cityPricePerKm: 25, cityPricePerMinute: 1.0, minimumPrice: 100 },
        'Бизнес': { boardingFee: 150, cityPricePerKm: 35, cityPricePerMinute: 1.5, minimumPrice: 150 },
    };

    function initMap() {
        if (!window.google || !window.google.maps) {
            console.error('Google Maps API не загружен');
            return;
        }
        map = new google.maps.Map(document.getElementById('map'), {
            center: OSH,
            zoom: 12,
            clickableIcons: false,
            gestureHandling: 'greedy',
        });

        geocoder = new google.maps.Geocoder();
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        directionsRenderer.setMap(map);

        map.addListener('click', (e) => onMapClick(e.latLng));

        document.getElementById('clear-markers-btn').addEventListener('click', clearRoute);
    }

    function onMapClick(latLng) {
        if (selecting !== 'end') {
            const marker = new google.maps.Marker({
                position: latLng,
                map,
                optimized: true,
            });
            if (selecting === 'a') {
                if (firstMarker) firstMarker.setMap(null);
                firstMarker = marker;
                selecting = 'b';
                reverseGeocode(latLng, 'origin');
            } else if (selecting === 'b') {
                if (secondMarker) secondMarker.setMap(null);
                secondMarker = marker;
                selecting = 'end';
                reverseGeocode(latLng, 'destination');
            }
        }

        if (firstMarker && secondMarker) {
            buildRoute(firstMarker.getPosition(), secondMarker.getPosition());
        }
    }

    function buildRoute(a, b) {
        directionsService.route({
            origin: a,
            destination: b,
            travelMode: google.maps.TravelMode.DRIVING
        }, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
                const leg = result.routes[0].legs[0];
                const distanceKm = leg.distance.value / 1000;
                const durationMin = leg.duration.value / 60;
                updateRouteInfo(distanceKm, durationMin);
                calculatePrice(distanceKm, durationMin);
            } else {
                // Fallback: простая эвристика
                const distanceKm = haversine(a.lat(), a.lng(), b.lat(), b.lng());
                const durationMin = (distanceKm / 30) * 60;
                updateRouteInfo(distanceKm, durationMin);
                calculatePrice(distanceKm, durationMin);
            }
        });
    }

    function updateRouteInfo(distanceKm, durationMin) {
        document.getElementById('distance').value = `Расстояние: ${distanceKm.toFixed(1)} км`;
        document.getElementById('duration').value = `Время в пути: ${durationMin.toFixed(0)} мин`;
    }

    function calculatePrice(distanceKm, durationMin) {
        const tariff = document.getElementById('tariff-select').value;
        if (!tariff || !TARIFFS[tariff]) return;
        const t = TARIFFS[tariff];
        let price = t.boardingFee + (distanceKm * t.cityPricePerKm) + (durationMin * t.cityPricePerMinute);
        if (tariff === 'Бизнес' && price < t.minimumPrice) {
            price = t.minimumPrice;
        }
        price = Math.ceil(price);
        document.getElementById('price').value = `Стоимость: ${price} сом`;
        document.getElementById('calculated-price').value = String(price);
        document.getElementById('boarding-fee').value = `Посадка: ${t.boardingFee} сом`;
        document.getElementById('tariff-display').value = tariff;
    }

    function reverseGeocode(latLng, type) {
        geocoder.geocode({ location: latLng }, (results, status) => {
            if (status === 'OK' && results[0]) {
                const address = results[0].formatted_address;
                if (type === 'origin') {
                    document.getElementById('origin-address').value = address;
                } else {
                    document.getElementById('destination-address').value = address;
                }
            } else {
                const coordsStr = `${latLng.lat().toFixed(6)}, ${latLng.lng().toFixed(6)}`;
                if (type === 'origin') {
                    document.getElementById('origin-address').value = coordsStr;
                } else {
                    document.getElementById('destination-address').value = coordsStr;
                }
            }
        });
    }

    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // Инициализация после загрузки скрипта Google
    const waitForGoogle = setInterval(() => {
        if (window.google && window.google.maps) {
            clearInterval(waitForGoogle);
            initMap();
        }
    }, 100);

    // Обработчики UI
    document.addEventListener('DOMContentLoaded', function() {
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            $('#driver-phone').val(phone);
            if (tariff) {
                $('#tariff-select').val(tariff).trigger('change');
            }
        });

        $('#tariff-select').change(function() {
            const tariff = $(this).val();
            if (tariff && firstMarker && secondMarker) {
                const a = firstMarker.getPosition();
                const b = secondMarker.getPosition();
                const distanceKm = haversine(a.lat(), a.lng(), b.lat(), b.lng());
                const durationMin = (distanceKm / 30) * 60;
                calculatePrice(distanceKm, durationMin);
            }
        });

        $('#clear-markers-btn').click(function() {
            clearRoute();
        });

        $('#order-form').submit(function(e) {
            e.preventDefault();
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            if (!driverId || !tariff || !paymentMethod || !origin || !destination) {
                alert('Заполните все поля');
                return false;
            }
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function() { window.location.href = '/disp/'; },
                error: function(error) { alert('Ошибка: ' + (error.responseJSON ? error.responseJSON.detail : 'Проверьте соединение с сервером')); }
            });
        });

        $('#cancel-btn').click(function() {
            if (confirm('Отменить создание заказа?')) window.location.href = '/disp/';
        });
    });

    function clearRoute() {
        selecting = 'a';
        if (firstMarker) { firstMarker.setMap(null); firstMarker = null; }
        if (secondMarker) { secondMarker.setMap(null); secondMarker = null; }
        if (directionsRenderer) directionsRenderer.set('directions', null);
        $('#origin-address').val('');
        $('#destination-address').val('');
        $('#distance').val('Расстояние: 0 км');
        $('#duration').val('Время в пути: 0 мин');
        $('#price').val('Стоимость: 0 сом');
        $('#calculated-price').val('0');
    }
</script>
<style>
    #map { width: 100%; height: 420px; }
</style>
{% endblock %}