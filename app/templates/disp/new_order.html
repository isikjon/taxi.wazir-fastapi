{% extends "base.html" %}

{% block title %}Новый заказ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="Поиск">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>Заказ №</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Дата время</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Путевой лист</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>Выберите водителя</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>Вариант</option>
                                <option value="Эконом">Эконом</option>
                                <option value="Комфорт">Комфорт</option>
                                <option value="Комфорт+">Комфорт+</option>
                                <option value="Бизнес">Бизнес</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>Оплата</option>
                                <option value="Наличные">Наличные</option>
                                <option value="На карту">На карту</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="Откуда (адрес отправления)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="Куда (адрес назначения)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="Примечание"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">Заказ другому человеку</button>
                        <button type="button" class="main__btn-short">Дополнительные услуги</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Заказ</th>
                                <th>Время</th>
                                <th>Откуда</th>
                                <th>Куда</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">Нет данных о последних заказах</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map">
                    <!-- 2ГИС карта будет загружена сюда -->
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">Данные для рассчета</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">Очистить маркеры</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="Эконом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="Посадка: 48 сом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="Расстояние: 0 км">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="Время в пути: 0 мин">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="Стоимость: 0 сом">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">Заказать</button>
            <button type="button" id="cancel-btn" class="main__btn">Отменить</button>
        </div>
    </form>
</div>

<!-- Подключение 2ГИС MapGL JS API -->
<script src="https://mapgl.2gis.com/api/js"></script>
<script>
    // Ждём загрузки DOM и jQuery
    document.addEventListener('DOMContentLoaded', function() {
        // Ждём также загрузки jQuery
        function waitForJQuery() {
            if (typeof $ !== 'undefined') {
                initApp();
            } else {
                setTimeout(waitForJQuery, 100);
            }
        }
        waitForJQuery();
    });

    function initApp() {
        console.log('jQuery готов');
        
        // Глобальные переменные для карты и маршрутов
        let map;
        let originMarker = null;
        let destinationMarker = null;
        let routeLayer = null;
        let originCoords = null;
        let destinationCoords = null;
        let distance = 0;
        let duration = 0;
        
        // Тарифы для расчета стоимости
        const TARIFFS = {
            'Эконом': {
                boardingFee: 50,
                cityPricePerKm: 15,
                cityPricePerMinute: 0.5,
                minimumPrice: 50
            },
            'Комфорт': {
                boardingFee: 80,
                cityPricePerKm: 20,
                cityPricePerMinute: 0.8,
                minimumPrice: 80
            },
            'Комфорт+': {
                boardingFee: 100,
                cityPricePerKm: 25,
                cityPricePerMinute: 1.0,
                minimumPrice: 100
            },
            'Бизнес': {
                boardingFee: 150,
                cityPricePerKm: 35,
                cityPricePerMinute: 1.5,
                minimumPrice: 150
            },
            'Премиум': {
                boardingFee: 200,
                cityPricePerKm: 45,
                cityPricePerMinute: 2.0,
                minimumPrice: 200
            }
        };

        // Инициализация карты 2GIS
        function initMap() {
            try {
                console.log('🗺️ Инициализация карты 2GIS...');
                
                // Проверяем, загружена ли библиотека 2GIS
                if (typeof mapgl === 'undefined') {
                    console.error('❌ Библиотека 2GIS MapGL не загружена');
                    return;
                }
                
                // Создаем карту
                const apiKey = '{{ twogis_api_key or "" }}';
                console.log('🔑 API ключ для карты:', apiKey);
                
                if (!apiKey || apiKey.trim() === '') {
                    console.error('❌ API ключ 2GIS не передан в шаблон!');
                    return;
                }
                
                map = new mapgl.Map('map', {
                    center: [72.8019, 40.5138], // Ош, Киргизия
                    zoom: 12,
                    key: apiKey // API ключ из конфигурации
                });
                
                console.log('✅ Карта 2GIS инициализирована');

                // Обработчик клика по карте
                map.on('click', function(e) {
                    const coords = e.lngLat;
                    console.log('📍 Клик по карте:', coords);
                        
                    // Определяем, какую точку устанавливаем
                    if (!originCoords) {
                            setMarkerByClick(coords, 'origin');
                    } else if (!destinationCoords) {
                            setMarkerByClick(coords, 'destination');
                    } else {
                        // Если обе точки установлены, спрашиваем пользователя
                        if (confirm('Обе точки уже установлены. Очистить и установить новую точку А?')) {
                            clearMarkers();
                            setMarkerByClick(coords, 'origin');
                        }
                    }
                });

                // Отключаем двойной клик для предотвращения нежелательных alert'ов
                map.on('dblclick', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Добавляем элементы управления
                // map.addControl(new mapgl.NavigationControl()); // Удален NavigationControl
                
            } catch (error) {
                console.error('❌ Ошибка инициализации карты:', error);
            }
        }

        // Функция для очистки всех маркеров
        function clearMarkers() {
            if (originMarker) {
                originMarker.destroy();
                originMarker = null;
            }
            if (destinationMarker) {
                destinationMarker.destroy();
                destinationMarker = null;
            }
            if (routeLayer) {
                routeLayer.destroy();
                routeLayer = null;
            }
            originCoords = null;
            destinationCoords = null;
            distance = 0;
            duration = 0;
            
            $('#origin-address').val('');
            $('#destination-address').val('');
            $('#distance').val('Расстояние: 0 км');
            $('#duration').val('Время в пути: 0 мин');
            $('#price').val('Стоимость: 0 сом');
            $('#calculated-price').val('0');
            $('#boarding-fee').val('Посадка: 0 сом');
        }

        // Функция для геокодирования адреса через 2GIS API
        async function geocodeAddress(address) {
            try {
                console.log('🔍 Геокодирование адреса:', address);
                
                const response = await fetch(`/api/twogis/geocode?address=${encodeURIComponent(address)}&region=kg`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('✅ Адрес найден:', data.data);
                    return data.data;
                } else {
                    console.log('❌ Адрес не найден');
                    return null;
                }
            } catch (error) {
                console.error('❌ Ошибка геокодирования:', error);
                return null;
            }
        }

        // Функция для поиска адресов с автодополнением
        async function searchAddresses(query) {
            try {
                if (query.length < 3) return [];
                
                const response = await fetch(`/api/twogis/search?query=${encodeURIComponent(query)}&limit=5&region=kg`);
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    return [];
                }
            } catch (error) {
                console.error('❌ Ошибка поиска адресов:', error);
                return [];
            }
        }

        // Функция для получения маршрута через 2GIS API
        async function getRouteFromAPI(origin, destination) {
            try {
                console.log('🗺️ Получение маршрута через 2GIS API...');
                
                const response = await fetch('/api/twogis/route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'origin_lat': origin[1],
                        'origin_lon': origin[0],
                        'destination_lat': destination[1],
                        'destination_lon': destination[0],
                        'transport_type': 'car'
                    })
                });
            
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('✅ Маршрут получен:', data.data);
                    return data.data;
                } else {
                    console.log('❌ Маршрут не получен');
                    return null;
                }
            } catch (error) {
                console.error('❌ Ошибка получения маршрута:', error);
                return null;
            }
        }

        // Функция для установки маркера по адресу
        async function setMarkerByAddress(address, type) {
            try {
                console.log(`🔍 Поиск координат для адреса (${type}):`, address);
                
                const geocodeResult = await geocodeAddress(address);
                if (geocodeResult) {
                    const coords = [geocodeResult.lon, geocodeResult.lat];
                    
            if (type === 'origin') {
                        originCoords = coords;
                        if (originMarker) originMarker.destroy();
                
                originMarker = new mapgl.Marker(map, {
                            coordinates: coords,
                    icon: {
                        type: 'pin',
                        color: '#FF4444',
                        size: 'large'
                    }
                });
                
                        $('#origin-address').val(geocodeResult.address);
                        console.log('✅ Точка А установлена по адресу');
                        
            } else if (type === 'destination') {
                        destinationCoords = coords;
                        if (destinationMarker) destinationMarker.destroy();
                
                destinationMarker = new mapgl.Marker(map, {
                            coordinates: coords,
                    icon: {
                        type: 'pin',
                        color: '#44FF44',
                        size: 'large'
                    }
                });
                
                        $('#destination-address').val(geocodeResult.address);
                        console.log('✅ Точка Б установлена по адресу');
            }
                    
                    // Обновляем маршрут, если обе точки установлены
                    if (originCoords && destinationCoords) {
                calculateRoute();
            }
                    
                    return true;
                } else {
                    console.log('❌ Не удалось найти координаты для адреса');
                    return false;
                }
            } catch (error) {
                console.error('❌ Ошибка установки маркера по адресу:', error);
                return false;
            }
        }

        // Функция для установки маркера при клике
        function setMarkerByClick(coords, type) {
            const lng = coords.getLng();
            const lat = coords.getLat();
            
            console.log('📍 Установка маркера', type, 'по координатам:', lat, lng);
            
                    if (type === 'origin') {
                if (originMarker) originMarker.destroy();
                    
                originCoords = [lng, lat];
                    originMarker = new mapgl.Marker(map, {
                        coordinates: originCoords,
                        icon: {
                            type: 'pin',
                            color: '#FF4444',
                            size: 'large'
                        }
                    });
                    
                // Пытаемся получить адрес по координатам
                reverseGeocode(lat, lng, 'origin');
                console.log('✅ Точка А установлена');
                        
                    } else if (type === 'destination') {
                if (destinationMarker) destinationMarker.destroy();
                    
                destinationCoords = [lng, lat];
                    destinationMarker = new mapgl.Marker(map, {
                        coordinates: destinationCoords,
                        icon: {
                            type: 'pin',
                            color: '#44FF44',
                            size: 'large'
                        }
                    });
                    
                // Пытаемся получить адрес по координатам
                reverseGeocode(lat, lng, 'destination');
                console.log('✅ Точка Б установлена');
                }
                
            // Обновляем маршрут, если обе точки установлены
                if (originCoords && destinationCoords) {
                        calculateRoute();
                }
        }

        // Обратная геокодировка (координаты -> адрес)
        async function reverseGeocode(lat, lon, type) {
            try {
                // Используем простой формат координат как адрес
                const address = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                
                if (type === 'origin') {
                    $('#origin-address').val(address);
                } else if (type === 'destination') {
                    $('#destination-address').val(address);
                }
            } catch (error) {
                console.error('❌ Ошибка обратной геокодировки:', error);
            }
        }

        // Расчет маршрута через 2GIS API
        async function calculateRoute() {
            try {
                console.log('🗺️ Расчет маршрута через 2GIS API...');
            
                if (!originCoords || !destinationCoords) {
                    console.log('❌ Не заданы начальная или конечная точки маршрута');
                return;
            }
            
                // Получаем маршрут через API
                const routeData = await getRouteFromAPI(originCoords, destinationCoords);
                
                if (routeData) {
                    // Обновляем данные о маршруте
                    distance = routeData.distance / 1000; // переводим в километры
                    duration = routeData.duration / 60;   // переводим в минуты
                    
                    console.log('📏 Маршрут рассчитан:', {
                        расстояние: distance.toFixed(1) + ' км',
                        время: duration.toFixed(0) + ' мин',
                        тип_транспорта: routeData.transport_type || 'автомобиль'
                    });
                    
                    // Обновляем отображение
                    $('#distance').val(`Расстояние: ${distance.toFixed(1)} км`);
                    $('#duration').val(`Время в пути: ${duration.toFixed(0)} мин`);
                    
                    // Пересчитываем стоимость
                    const calculatedPrice = calculatePrice();
                    console.log('💰 Стоимость пересчитана:', calculatedPrice + ' сом');
                    
                    // Показываем линию маршрута
                    if (routeLayer) {
                        routeLayer.destroy();
                    }
                    
                    // Если есть геометрия маршрута, используем её
                    if (routeData.geometry && routeData.geometry.coordinates) {
                        routeLayer = new mapgl.Polyline(map, {
                            coordinates: routeData.geometry.coordinates,
                            color: '#2196F3',
                            width: 6
                        });
                        console.log('🎯 Маршрут отрисован с использованием геометрии 2GIS');
                    } else {
                        // Иначе рисуем прямую линию
                    routeLayer = new mapgl.Polyline(map, {
                        coordinates: [originCoords, destinationCoords],
                        color: '#00FFFC',
                        width: 5
                    });
                        console.log('⚠️ Маршрут отрисован прямой линией (нет геометрии)');
                    }
                    
                    // Подстраиваем карту под маршрут
                    const bounds = [
                        [Math.min(originCoords[0], destinationCoords[0]), Math.min(originCoords[1], destinationCoords[1])],
                        [Math.max(originCoords[0], destinationCoords[0]), Math.max(originCoords[1], destinationCoords[1])]
                    ];
                    map.fitBounds(bounds, { padding: 50 });
                    
                    console.log('✅ Маршрут успешно построен и отображен на карте');
                    
                } else {
                    // Fallback на простой расчет
                    console.log('⚠️ Используем упрощенный расчет маршрута');
                    calculateSimpleRoute();
                }
                
            } catch (error) {
                console.error('❌ Ошибка расчета маршрута:', error);
                // Fallback на простой расчет
                calculateSimpleRoute();
            }
        }

        // Упрощенный расчет маршрута (fallback)
        function calculateSimpleRoute() {
            if (originCoords && destinationCoords) {
                // Расчет расстояния по прямой
                distance = calculateDistance(originCoords[1], originCoords[0], destinationCoords[1], destinationCoords[0]);
                // Примерное время в минутах (средняя скорость 30 км/ч в городе)
                duration = (distance / 30) * 60;
                
                console.log('📏 Простой расчет маршрута:', {
                    расстояние: distance.toFixed(1) + ' км (по прямой)',
                    время: duration.toFixed(0) + ' мин (примерно)',
                    скорость: '30 км/ч (городская)'
                });
                
                $('#distance').val(`Расстояние: ${distance.toFixed(1)} км (по прямой)`);
                $('#duration').val(`Время в пути: ${duration.toFixed(0)} мин (примерно)`);
                
                // Пересчитываем стоимость
                const calculatedPrice = calculatePrice();
                console.log('💰 Стоимость пересчитана (простой расчет):', calculatedPrice + ' сом');
                
                // Показываем прямую линию
                if (routeLayer) {
                    routeLayer.destroy();
                }
                
                routeLayer = new mapgl.Polyline(map, {
                    coordinates: [originCoords, destinationCoords],
                    color: '#2196F3',
                    width: 5
                });
                
                console.log('⚠️ Маршрут отрисован прямой линией (упрощенный расчет)');
            }
        }

        // Функция расчета расстояния между двумя точками
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Радиус Земли в км
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Расчет стоимости поездки
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('💰 Расчет цены для тарифа:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('❌ Тариф не выбран или не найден в списке тарифов:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                // Обновляем отображение тарифа
                $('#tariff-display').val(tariff);
                
                // Проверяем, что у нас есть данные о расстоянии и времени
                if (distance > 0 && duration > 0) {
                    const pricePerKm = tariffData.cityPricePerKm;
                    const pricePerMinute = tariffData.cityPricePerMinute;
                    
                    const distancePrice = distance * pricePerKm;
                    const timePrice = duration * pricePerMinute;
                    
                    price += distancePrice + timePrice;
                    
                    console.log('📊 Детали расчета:', {
                        посадка: tariffData.boardingFee + ' сом',
                        расстояние: distance.toFixed(1) + ' км × ' + pricePerKm + ' сом/км = ' + distancePrice.toFixed(0) + ' сом',
                        время: duration.toFixed(0) + ' мин × ' + pricePerMinute + ' сом/мин = ' + timePrice.toFixed(0) + ' сом',
                        промежуточная_сумма: (tariffData.boardingFee + distancePrice + timePrice).toFixed(0) + ' сом'
                    });
                } else {
                    console.log('⚠️ Нет данных о расстоянии или времени, используется только стоимость посадки');
                    if (distance <= 0) {
                        $('#distance').val('Расстояние не рассчитано');
                    }
                    if (duration <= 0) {
                        $('#duration').val('Время не рассчитано');
                    }
                }
                
                // Минимальная стоимость для бизнес-класса
                if (tariff === 'Бизнес' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                    console.log('🏢 Применена минимальная стоимость для бизнес-класса:', tariffData.minimumPrice + ' сом');
                }
                
                // Округляем до целого числа
                price = Math.ceil(price);
                
                // Обновляем отображение
                $('#price').val(`Стоимость: ${price} сом`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`Посадка: ${tariffData.boardingFee} сом`);
                
                // Добавляем информацию о времени в пути
                if (duration > 0) {
                    $('#duration').val(`Время в пути: ${duration.toFixed(0)} мин`);
                }
                
                console.log('✅ Итоговый расчет стоимости:', {
                    тариф: tariff,
                    расстояние: distance > 0 ? distance.toFixed(1) + ' км' : 'не рассчитано',
                    время: duration > 0 ? duration.toFixed(0) + ' мин' : 'не рассчитано',
                    стоимость_посадки: tariffData.boardingFee + ' сом',
                    итоговая_цена: price + ' сом'
                });
                
                return price;
                
            } catch (error) {
                console.error('❌ Ошибка при расчете стоимости:', error);
                $('#price').val('Ошибка расчета');
                return 0;
            }
        }

        // Инициализация карты при загрузке страницы
        $(window).on('load', function() {
            console.log('Страница полностью загружена, инициализация карты...');
            setTimeout(function() {
                try {
                    initMap();
                    console.log('Карта инициализирована после загрузки страницы');
                } catch (error) {
                    console.error('Ошибка инициализации карты после загрузки страницы:', error);
                }
            }, 500);
        });

        // Обработчики событий
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
            try {
                const tariff = $(this).val();
                console.log('Изменение тарифа на:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
                }
            } catch (error) {
                console.error('Ошибка при изменении тарифа:', error);
            }
        });
        
        // Обновление адресов при изменении полей
        $('#origin-address, #destination-address').on('change keyup', function() {
            const fieldId = $(this).attr('id');
            const address = $(this).val().trim();
            console.log('Изменен адрес в поле:', fieldId, '→', address);
            
            // Устанавливаем маркер на карте по введенному адресу
            if (address.length > 2) {
                const type = fieldId.includes('origin') ? 'origin' : 'destination';
                console.log('🎯 Устанавливаем маркер для:', type);
                
                // Небольшая задержка чтобы не спамить при наборе
                clearTimeout(window.addressTimeout);
                window.addressTimeout = setTimeout(function() {
                    setMarkerByAddress(address, type);
                }, 800); // 800мс задержка
            }
        });

        // Инициализация автодополнения для полей адресов
        function initAutocomplete() {
            $('#origin-address, #destination-address').each(function() {
                const $input = $(this);
                const $container = $input.parent();
                
                // Создаем контейнер для выпадающего списка
                if (!$container.find('.autocomplete-dropdown').length) {
                    $container.css('position', 'relative');
                    $container.append('<div class="autocomplete-dropdown"></div>');
                }
                
                const $dropdown = $container.find('.autocomplete-dropdown');
                
                $input.on('input', function() {
                    const value = $(this).val().toLowerCase().trim();
                    $dropdown.empty().hide();
                    
                    if (value.length >= 2) {
                        searchAddresses(value).then(addresses => {
                            if (addresses.length > 0) {
                                addresses.forEach(address => {
                                    const $item = $('<div class="autocomplete-item">' + address.name + '</div>');
                                $item.on('click', function() {
                                        $input.val(address.name);
                                    $dropdown.hide();
                                        console.log('✅ Выбран адрес из автодополнения:', address.name);
                                    
                                    // Сразу устанавливаем маркер при выборе из списка
                                    const type = $input.attr('id').includes('origin') ? 'origin' : 'destination';
                                    console.log('🎯 Устанавливаем маркер для выбранного адреса:', type);
                                        setMarkerByAddress(address.name, type);
                                });
                                $dropdown.append($item);
                            });
                            $dropdown.show();
                        }
                        });
                    }
                });
                
                // Скрываем выпадающий список при клике вне его
                $(document).on('click', function(e) {
                    if (!$container.is(e.target) && !$container.has(e.target).length) {
                        $dropdown.hide();
                    }
                });
            });
        }

        // Инициализируем автодополнение после загрузки
        setTimeout(initAutocomplete, 500);
        
        // Валидация адресов для Киргизии при ручном вводе (делаем менее строгой)
        $('#origin-address, #destination-address').on('blur', function() {
            const address = $(this).val().toLowerCase().trim();
            // Убираем строгую валидацию - проверяем только если введено что-то
            if (address && address.length > 2) {
                if (!isKyrgyzstanAddress(address)) {
                    // Не показываем alert, просто логируем предупреждение
                    console.warn('Введенный адрес может не относиться к Киргизии:', address);
                }
            }
        });
        
        // Проверка, относится ли адрес к Киргизии (улучшенная версия)
        function isKyrgyzstanAddress(address) {
            const kyrgyzstanKeywords = [
                'кыргызстан', 'киргизия', 'бишкек', 'ош', 'джалал-абад', 'джалалабад',
                'каракол', 'нарын', 'талас', 'баткен', 'чуй', 'иссык-куль', 'исыккуль',
                'кг', 'kg', 'bishkek', 'osh', 'jalal-abad', 'karakol', 
                'naryn', 'talas', 'batken', 'чолпон-ата', 'кербен', 'токмак',
                'кант', 'сокулук', 'беловодское', 'кемин', 'чолпон', 'ата',
                'кочкор', 'ат-башы', 'кызыл-кия', 'сулюкта', 'узген',
                'арсланбоб', 'майлуу-суу', 'жалал-абад', 'кайынды', 'базар-коргон',
                'ноокат', 'кара-суу', 'кара-кулжа', 'ленин', 'пик', 'ленина'
            ];
            
            // Если адрес содержит хотя бы одно ключевое слово - считаем валидным
            // Или если адрес просто числа/координаты - тоже валидным
            return kyrgyzstanKeywords.some(keyword => address.includes(keyword)) || 
                   /^[\d\.,\s\-]+$/.test(address); // Координаты или числа
        }
        
        // Обработка формы
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            
            if (!driverId) {
                alert('Выберите водителя');
                return false;
            }
            if (!tariff) {
                alert('Выберите тариф');
                return false;
            }
            if (!paymentMethod) {
                alert('Выберите способ оплаты');
                return false;
            }
            if (!origin) {
                alert('Укажите адрес отправления');
                return false;
            }
            if (!destination) {
                alert('Укажите адрес назначения');
                return false;
            }
            
            // Проверяем, что адреса находятся в пределах Киргизии (делаем менее строгим)
            if (!isKyrgyzstanAddress(origin.toLowerCase())) {
                console.warn('Внимание: адрес отправления может не относиться к Киргизии');
                // Не блокируем отправку, только предупреждаем
            }
            if (!isKyrgyzstanAddress(destination.toLowerCase())) {
                console.warn('Внимание: адрес назначения может не относиться к Киргизии');
                // Не блокируем отправку, только предупреждаем
            }
            
            // Отправка формы
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function(response) {
                    alert('Заказ успешно создан!');
                    window.location.href = '/disp/';
                },
                error: function(error) {
                    alert('Ошибка при создании заказа: ' + (error.responseJSON ? error.responseJSON.detail : 'Проверьте соединение с сервером'));
                }
            });
        });
        
        // Отмена заказа
        $('#cancel-btn').click(function() {
            if (confirm('Вы уверены, что хотите отменить создание заказа?')) {
                window.location.href = '/disp/';
            }
        });
        
        // Нажатие клавиши F2 для создания нового заказа
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2 key
                e.preventDefault();
                window.location.reload();
            }
        });

        // Обработчик для кнопки "Очистить маркеры"
        $('#clear-markers-btn').click(function() {
            if (confirm('Очистить все маркеры и поля адресов?')) {
                clearMarkers();
                console.log('✅ Все данные очищены, карта сброшена к начальному состоянию');
            }
        });
    } // Закрытие функции initApp
</script>
<style>
    /* Адаптивные стили */
    .main__order-wrapper {
        border-radius: 5px;
    }
    .main__order-header {
        flex-wrap: wrap;
    }
    .main__btn {
        padding: 12px 30px;
    }
    .main__order-subheader {
        gap: 20px;
        flex-wrap: wrap;
    }
    .main__order-subheader-item {
        width: 100%;
    } 
    .main__subheader-filing {
        width: 100%;
    }
    #tariff-select,
    #payment-method {
        width: 100%;
    }
    .main__order-subheader-item .main__btn-short {
        width: 100%;
    }
    .main__order-notes {
        width: 100%;
        display: flex;
        justify-content: space-between;
    } 
    .main__order-notes-text {
        width: 65%;
    }
    @media (max-width: 1200px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        .main__order-settings, .main__order-map {
            width: 100%;
            margin-bottom: 20px;
        }
        .main__header-tags ul li {
            padding: 10px 15px;
        }
    }
    
    @media (max-width: 768px) {
        .main__header {
            flex-direction: column;
            align-items: flex-start;
        }
        .main__header-logo, .main__header-tags, .main__header-search {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__subheader-add {
            flex-wrap: wrap;
        }
        .main__order-header, .main__order-subheader {
            flex-direction: column;
        }
        .main__order-header-item, .main__order-subheader-item {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-details-item {
            flex-direction: column;
        }
        .main__order-details-item input {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-map-item {
            height: 300px;
        }
    }
    
    /* Улучшения существующих стилей */
    .main__order-map-item {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main__btn, .main__btn-short, .main__btn-green {
        transition: all 0.3s ease;
    }
    
    .main__btn:hover, .main__btn-short:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__btn-green:hover {
        background-color: #35a63a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__order-notes-text textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        resize: vertical;
    }
    
    /* Улучшения для карты и маршрута */
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .route-info-item {
        background-color: #47484c;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .route-info-item input {
        width: 90%;
    }
    
    /* Стили для автодополнения адресов */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #2d2e33;
        border: 1px solid #47484c;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        color: #fff;
        border-bottom: 1px solid #47484c;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #47484c;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    /* Улучшение стилей для полей ввода адресов */
    .main__order-details-item {
        position: relative;
    }
    
    @media (max-width: 576px) {
        .route-info-item {
            width: 100%;
        }
    }
</style>
{% endblock %}