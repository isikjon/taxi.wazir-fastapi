{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="–ü–æ–∏—Å–∫">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>–ó–∞–∫–∞–∑ ‚Ññ</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–î–∞—Ç–∞ –≤—Ä–µ–º—è</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–ü—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>–í–∞—Ä–∏–∞–Ω—Ç</option>
                                <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç+">–ö–æ–º—Ñ–æ—Ä—Ç+</option>
                                <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>–û–ø–ª–∞—Ç–∞</option>
                                <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="–ù–∞ –∫–∞—Ä—Ç—É">–ù–∞ –∫–∞—Ä—Ç—É</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">–ó–∞–∫–∞–∑ –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É</button>
                        <button type="button" class="main__btn-short">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>–ó–∞–∫–∞–∑</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–û—Ç–∫—É–¥–∞</th>
                                <th>–ö—É–¥–∞</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–∞—Ö</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map">
                    <!-- 2–ì–ò–° –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—é–¥–∞ -->
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Å—á–µ—Ç–∞</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="–≠–∫–æ–Ω–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="–ü–æ—Å–∞–¥–∫–∞: 48 —Å–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button type="button" id="cancel-btn" class="main__btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ 2–ì–ò–° MapGL JS API –∏ Directions API -->
<script src="https://mapgl.2gis.com/api/js/v1"></script>
<script src="https://unpkg.com/@2gis/mapgl-directions@^2/dist/directions.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function waitForJQuery() {
            if (typeof $ !== 'undefined') {
                initApp();
            } else {
                setTimeout(waitForJQuery, 100);
            }
        }
        waitForJQuery();
    });

    function initApp() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Directions API');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let directions;
        let firstPoint;
        let secondPoint;
        let selecting = 'a';
        let markers = [];
        let distance = 0;
        let duration = 0;
        
        // –¢–∞—Ä–∏—Ñ—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const TARIFFS = {
            '–≠–∫–æ–Ω–æ–º': {
                boardingFee: 50,
                cityPricePerKm: 15,
                cityPricePerMinute: 0.5,
                minimumPrice: 50
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç': {
                boardingFee: 80,
                cityPricePerKm: 20,
                cityPricePerMinute: 0.8,
                minimumPrice: 80
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç+': {
                boardingFee: 100,
                cityPricePerKm: 25,
                cityPricePerMinute: 1.0,
                minimumPrice: 100
            },
            '–ë–∏–∑–Ω–µ—Å': {
                boardingFee: 150,
                cityPricePerKm: 35,
                cityPricePerMinute: 1.5,
                minimumPrice: 150
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS —Å Directions API
        function initMap() {
            try {
                console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å Directions API...');
                
                if (typeof mapgl === 'undefined') {
                    console.error('‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 2GIS MapGL –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    return;
                }
                
                const apiKey = '{{ twogis_api_key or "" }}';
                console.log('üîë API –∫–ª—é—á –¥–ª—è –∫–∞—Ä—Ç—ã:', apiKey);
                
                if (!apiKey || apiKey.trim() === '') {
                    console.error('‚ùå API –∫–ª—é—á 2GIS –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ —à–∞–±–ª–æ–Ω!');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                map = new mapgl.Map('map', {
                    center: [72.8019, 40.5138], // –û—à, –ö–∏—Ä–≥–∏–∑–∏—è
                    zoom: 12,
                    key: apiKey
                });
                
                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Directions API
                if (typeof mapgl.Directions !== 'undefined') {
                    directions = new mapgl.Directions(map, {
                        directionsApiKey: apiKey
                    });
                    console.log('‚úÖ Directions API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } else {
                    console.error('‚ùå Directions API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }

                // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê CSS –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–Ø
                const mapContainer = document.getElementById('map');
                const mapRect = mapContainer.getBoundingClientRect();
                console.log('üó∫Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–ê –ö–ê–†–¢–´:', {
                    container_element: mapContainer,
                    bounding_rect: mapRect,
                    computed_style: window.getComputedStyle(mapContainer),
                    position: window.getComputedStyle(mapContainer).position,
                    transform: window.getComputedStyle(mapContainer).transform,
                    parent_styles: window.getComputedStyle(mapContainer.parentElement)
                });
                
                // –û–¢–õ–ê–î–ö–ê –ú–´–®–ò - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                let lastMouseUpdate = 0;
                map.on('mousemove', function(e) {
                    const now = Date.now();
                    if (now - lastMouseUpdate > 1000) { // –†–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
                        const mouseCoords = [e.lngLat[0], e.lngLat[1]];
                        const pixelCoords = e.point;
                        
                        console.log('üñ±Ô∏è –î–í–ò–ñ–ï–ù–ò–ï –ú–´–®–ò:', {
                            geo_coords: mouseCoords,
                            pixel_coords: pixelCoords,
                            formatted: `${mouseCoords[1].toFixed(6)}, ${mouseCoords[0].toFixed(6)}`,
                            container_offset: {
                                x: pixelCoords[0] + mapRect.left,
                                y: pixelCoords[1] + mapRect.top
                            }
                        });
                        
                        window.lastMouseCoords = mouseCoords;
                        window.lastPixelCoords = pixelCoords;
                        lastMouseUpdate = now;
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.on('click', function(e) {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
                    const lngLat = e.lngLat;
                    const coords = [lngLat[0], lngLat[1]]; // lng, lat
                    const pixelCoords = e.point; // –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
                    
                    // –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–õ–ò–ö–ê
                    const mapRect = mapContainer.getBoundingClientRect();
                    console.log('üìç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–õ–ò–ö–ê:', {
                        event_coords: coords,
                        pixel_coords: pixelCoords,
                        last_mouse_coords: window.lastMouseCoords,
                        –†–ê–ó–ù–û–°–¢–¨_–ö–û–û–†–î–ò–ù–ê–¢: window.lastMouseCoords ? {
                            lat_diff: (coords[1] - window.lastMouseCoords[1]) * 100000,
                            lng_diff: (coords[0] - window.lastMouseCoords[0]) * 100000,
                            pixel_diff: window.lastPixelCoords ? [
                                pixelCoords[0] - window.lastPixelCoords[0],
                                pixelCoords[1] - window.lastPixelCoords[1]
                            ] : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                        } : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –º—ã—à–∏',
                        container_info: {
                            rect: mapRect,
                            scroll: { x: window.scrollX, y: window.scrollY },
                            offset: { x: pixelCoords[0] + mapRect.left, y: pixelCoords[1] + mapRect.top }
                        },
                        selecting: selecting
                    });
                    
                    if (selecting !== 'end') {
                        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –ë–ï–ó —Å–º–µ—â–µ–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
                        const marker = new mapgl.Marker(map, {
                            coordinates: coords,
                            color: selecting === 'a' ? '#FF0000' : '#00FF00'
                        });
                        
                        markers.push(marker);
                        console.log('üéØ –°–û–ó–î–ê–ù–ò–ï –ú–ê–†–ö–ï–†–ê:', {
                            input_coords: coords,
                            pixel_click: pixelCoords,
                            container_rect: mapRect,
                            –ü–†–û–ë–õ–ï–ú–ê: '–°–º–æ—Ç—Ä–∏ —Ä–∞–∑–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—ã—à–µ!'
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–¥–µ —Ä–µ–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª—Å—è –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 100–º—Å
                        setTimeout(function() {
                            console.log('üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø –ú–ê–†–ö–ï–†–ê:', {
                                original_coords: coords,
                                marker_element: marker,
                                DOM_–ø—Ä–æ–≤–µ—Ä–∫–∞: '–ò–Ω—Å–ø–µ–∫—Ç–∏—Ä—É–π –º–∞—Ä–∫–µ—Ä –≤ DevTools'
                            });
                        }, 100);
                    }

                    if (selecting === 'a') {
                        firstPoint = coords;
                        selecting = 'b';
                        console.log('‚úÖ –¢–æ—á–∫–∞ –ê —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', coords);
                        
                        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        getAddressByCoordinates(coords[1], coords[0], 'origin');
                        
                    } else if (selecting === 'b') {
                        secondPoint = coords;
                        selecting = 'end';
                        console.log('‚úÖ –¢–æ—á–∫–∞ –ë —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', coords);
                        
                        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        getAddressByCoordinates(coords[1], coords[0], 'destination');
                    }

                    // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ –≤—ã–±—Ä–∞–Ω—ã - —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                    if (firstPoint && secondPoint) {
                        console.log('üó∫Ô∏è –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ Directions API...');
                        console.log('–û—Ç:', firstPoint, '–î–æ:', secondPoint);
                        
                        directions.carRoute({
                            points: [firstPoint, secondPoint]
                        }).then(function(result) {
                            console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω:', result);
                            
                            // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                            markers.forEach(function(marker) {
                                marker.destroy();
                            });
                            markers = [];
                            
                            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞
                            if (result && result.length > 0) {
                                const route = result[0];
                                
                                distance = route.distance / 1000; // –∫–º
                                duration = route.duration / 60;   // –º–∏–Ω
                                
                                console.log('üìä –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞:', {
                                    distance: distance.toFixed(1) + ' –∫–º',
                                    duration: duration.toFixed(0) + ' –º–∏–Ω'
                                });
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                                updateRouteInfo();
                                calculatePrice();
                    } else {
                                console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                    calculateSimpleRoute();
                }
                
                        }).catch(function(error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç
                calculateSimpleRoute();
                        });
                    }
                });

                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∏ Directions API –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
        function updateRouteInfo() {
            $('#distance').val(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`);
            $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω`);
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('üí∞ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –≤—ã–±—Ä–∞–Ω:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                $('#tariff-display').val(tariff);
                
                if (distance > 0 && duration > 0) {
                    const distancePrice = distance * tariffData.cityPricePerKm;
                    const timePrice = duration * tariffData.cityPricePerMinute;
                    
                    price += distancePrice + timePrice;
                    
                    console.log('üìä –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:', {
                        –ø–æ—Å–∞–¥–∫–∞: tariffData.boardingFee + ' —Å–æ–º',
                        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º √ó ' + tariffData.cityPricePerKm + ' = ' + distancePrice.toFixed(0) + ' —Å–æ–º',
                        –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω √ó ' + tariffData.cityPricePerMinute + ' = ' + timePrice.toFixed(0) + ' —Å–æ–º'
                    });
                }
                
                if (tariff === '–ë–∏–∑–Ω–µ—Å' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                }
                
                price = Math.ceil(price);
                
                $('#price').val(`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} —Å–æ–º`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`–ü–æ—Å–∞–¥–∫–∞: ${tariffData.boardingFee} —Å–æ–º`);
                
                console.log('‚úÖ –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞:', price + ' —Å–æ–º');
                
                return price;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã:', error);
                $('#price').val('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
                return 0;
            }
        }

        // Fallback —Ä–∞—Å—á–µ—Ç (–µ—Å–ª–∏ Directions API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        function calculateSimpleRoute() {
            if (firstPoint && secondPoint) {
                const lat1 = firstPoint[1]; // lng
                const lng1 = firstPoint[0]; // lat
                const lat2 = secondPoint[1]; // lng
                const lng2 = secondPoint[0]; // lat
                
                distance = calculateDistance(lat1, lng1, lat2, lng2);
                duration = (distance / 30) * 60; // 30 –∫–º/—á —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å
                
                console.log('üìè –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç:', {
                    distance: distance.toFixed(1) + ' –∫–º',
                    duration: duration.toFixed(0) + ' –º–∏–Ω'
                });
                
                updateRouteInfo();
                calculatePrice();
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
        function clearRoute() {
            selecting = 'a';
            firstPoint = undefined;
            secondPoint = undefined;
            distance = 0;
            duration = 0;
            
            if (directions) {
                directions.clear();
            }
            
            markers.forEach(function(marker) {
                marker.destroy();
            });
            markers = [];
            
            $('#origin-address').val('');
            $('#destination-address').val('');
            $('#distance').val('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º');
            $('#duration').val('–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω');
            $('#price').val('–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º');
            $('#calculated-price').val('0');
            
            console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        $(window).on('load', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
            setTimeout(function() {
                try {
                    initMap();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                }
            }, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
                const tariff = $(this).val();
                console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        $('#clear-markers-btn').click(function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                clearRoute();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            
            if (!driverId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
                return false;
            }
            if (!tariff) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
                return false;
            }
            if (!paymentMethod) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
                return false;
            }
            if (!origin) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
                return false;
            }
            if (!destination) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
                return false;
            }
            
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function(response) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    window.location.href = '/disp/';
                },
                error: function(error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (error.responseJSON ? error.responseJSON.detail : '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º'));
                }
            });
        });
        
        $('#cancel-btn').click(function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?')) {
                window.location.href = '/disp/';
            }
        });
        
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2
                e.preventDefault();
                window.location.reload();
            }
        });
    }

    // –û–±—Ä–∞—Ç–Ω–∞—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∫–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –∞–¥—Ä–µ—Å)
    async function getAddressByCoordinates(lat, lon, type) {
        try {
            console.log(`üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ${lat}, ${lon}`);
            
            const response = await fetch(`/api/twogis/reverse-geocode?lat=${lat}&lon=${lon}`);
            const data = await response.json();
            
            if (data.success && data.address) {
                console.log(`‚úÖ –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω: ${data.address}`);
                
                if (type === 'origin') {
                    $('#origin-address').val(data.address);
                } else if (type === 'destination') {
                    $('#destination-address').val(data.address);
                }
            } else {
                console.warn('‚ö†Ô∏è –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                // Fallback –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                
                if (type === 'origin') {
                    $('#origin-address').val(coordsStr);
                } else if (type === 'destination') {
                    $('#destination-address').val(coordsStr);
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
            // Fallback –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            
            if (type === 'origin') {
                $('#origin-address').val(coordsStr);
            } else if (type === 'destination') {
                $('#destination-address').val(coordsStr);
            }
        }
    }
</script>
<style>
    /* –£–ü–†–û–©–ï–ù–ù–´–ï –°–¢–ò–õ–ò –¢–û–õ–¨–ö–û –î–õ–Ø 2GIS –ö–ê–†–¢–´ */
    #map {
        width: 100%;
        height: 400px;
        border: none;
        margin: 0;
        padding: 0;
        position: relative;
        overflow: hidden;
    }
    
    .main__order-map {
        width: 100%;
        display: block;
    }
    
    .main__order-map-item {
        width: 100%;
        height: 400px;
        display: block;
        position: relative;
        margin: 0;
        padding: 0;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    
    .main__order-wrapper-blocks {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .main__order-settings {
        flex: 1;
        min-width: 300px;
    }
    
    .main__order-map {
        flex: 1;
        min-width: 400px;
    }
    
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    .main__order-wrapper {
        border-radius: 5px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .main__order-header {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .main__order-subheader {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .main__order-details {
        margin-bottom: 15px;
    }
    
    .main__order-details-item {
        margin-bottom: 10px;
    }
    
    .main__btn, .main__btn-short {
        padding: 8px 15px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .main__btn-green {
        background-color: #28a745;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }
    
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .route-info-item {
        margin-bottom: 10px;
    }
    
    .route-info-item input {
        width: 100%;
        padding: 8px;
        background-color: #47484c;
        border: 1px solid #47484c;
        color: #fff;
        border-radius: 4px;
    }
    
    .main__order-wrapper-btn {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .main__table {
        margin-top: 20px;
    }
    
    .main__table table {
        width: 100%;
        border-collapse: collapse;
        background-color: #2d2e33;
        color: #fff;
    }
    
    .main__table th,
    .main__table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #47484c;
    }
    
    .main__table th {
        background-color: #47484c;
    }
    
    @media (max-width: 768px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        
        .main__order-settings,
        .main__order-map {
            width: 100%;
            min-width: unset;
        }
        
        .main__order-map-item {
            height: 300px;
        }
    }
</style>
{% endblock %}