{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="–ü–æ–∏—Å–∫">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>–ó–∞–∫–∞–∑ ‚Ññ</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–î–∞—Ç–∞ –≤—Ä–µ–º—è</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–ü—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>–í–∞—Ä–∏–∞–Ω—Ç</option>
                                <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç+">–ö–æ–º—Ñ–æ—Ä—Ç+</option>
                                <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>–û–ø–ª–∞—Ç–∞</option>
                                <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="–ù–∞ –∫–∞—Ä—Ç—É">–ù–∞ –∫–∞—Ä—Ç—É</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">–ó–∞–∫–∞–∑ –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É</button>
                        <button type="button" class="main__btn-short">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>–ó–∞–∫–∞–∑</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–û—Ç–∫—É–¥–∞</th>
                                <th>–ö—É–¥–∞</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–∞—Ö</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map">
                    <!-- 2–ì–ò–° –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—é–¥–∞ -->
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Å—á–µ—Ç–∞</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="–≠–∫–æ–Ω–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="–ü–æ—Å–∞–¥–∫–∞: 48 —Å–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button type="button" id="cancel-btn" class="main__btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Google Maps JS API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key or '' }}&libraries=places&v=weekly"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function waitForJQuery() {
            if (typeof $ !== 'undefined') {
                waitForGoogle();
            } else {
                setTimeout(waitForJQuery, 100);
            }
        }
        waitForJQuery();
    });

    function waitForGoogle() {
        if (window.google && window.google.maps) {
            initApp();
        } else {
            setTimeout(waitForGoogle, 100);
        }
    }

    function initApp() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Google Maps');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let placesAutocompleteService;
        let placesDetailsService;
        let firstPoint;
        let secondPoint;
        let selecting = 'a';
        let markers = [];
        let originMarker = null;
        let destinationMarker = null;
        let distance = 0;
        let duration = 0;
        
        // –¢–∞—Ä–∏—Ñ—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const TARIFFS = {
            '–≠–∫–æ–Ω–æ–º': {
                boardingFee: 50,
                cityPricePerKm: 15,
                cityPricePerMinute: 0.5,
                minimumPrice: 50
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç': {
                boardingFee: 80,
                cityPricePerKm: 20,
                cityPricePerMinute: 0.8,
                minimumPrice: 80
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç+': {
                boardingFee: 100,
                cityPricePerKm: 25,
                cityPricePerMinute: 1.0,
                minimumPrice: 100
            },
            '–ë–∏–∑–Ω–µ—Å': {
                boardingFee: 150,
                cityPricePerKm: 35,
                cityPricePerMinute: 1.5,
                minimumPrice: 150
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Maps
        function initMap() {
            try {
                console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Google...');

                const center = { lat: 40.5138, lng: 72.8019 };
                const KG_BOUNDS = new google.maps.LatLngBounds(
                    new google.maps.LatLng(39.172, 69.227), // SW
                    new google.maps.LatLng(43.260, 80.283)  // NE
                );
                map = new google.maps.Map(document.getElementById('map'), {
                    center: center,
                    zoom: 12,
                    restriction: { latLngBounds: KG_BOUNDS, strictBounds: false },
                    gestureHandling: 'greedy',
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
                directionsRenderer.setMap(map);
                geocoder = new google.maps.Geocoder();
                console.log('‚úÖ Google Maps –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

                // –°–µ—Ä–≤–∏—Å—ã Places
                placesAutocompleteService = new google.maps.places.AutocompleteService();
                placesDetailsService = new google.maps.places.PlacesService(map);

                // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∞–¥—Ä–µ—Å–æ–≤
                initCustomAutocomplete(KG_BOUNDS);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.addListener('click', function(e) {
                    const latLng = e.latLng;
                    const coords = { lat: latLng.lat(), lng: latLng.lng() };

                    if (selecting !== 'end') {
                        const marker = new google.maps.Marker({
                            position: coords,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 6,
                                fillColor: selecting === 'a' ? '#FF3B30' : '#34C759',
                                fillOpacity: 1,
                                strokeColor: '#FFFFFF',
                                strokeWeight: 2
                            }
                        });
                        markers.push(marker);
                    }

                    if (selecting === 'a') {
                        firstPoint = coords;
                        if (originMarker) originMarker.setMap(null);
                        originMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#FF3B30', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                        selecting = 'b';
                        getAddressByCoordinates(coords.lat, coords.lng, 'origin');
                    } else if (selecting === 'b') {
                        secondPoint = coords;
                        if (destinationMarker) destinationMarker.setMap(null);
                        destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#34C759', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                        selecting = 'end';
                        getAddressByCoordinates(coords.lat, coords.lng, 'destination');
                    }

                    if (firstPoint && secondPoint) {
                        directionsService.route({
                            origin: firstPoint,
                            destination: secondPoint,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, function(response, status) {
                            if (status === google.maps.DirectionsStatus.OK) {
                                directionsRenderer.setDirections(response);
                                const leg = response.routes[0].legs[0];
                                distance = (leg.distance && leg.distance.value ? leg.distance.value : 0) / 1000; // –∫–º
                                duration = (leg.duration && leg.duration.value ? leg.duration.value : 0) / 60; // –º–∏–Ω
                                updateRouteInfo();
                                calculatePrice();
                            } else {
                                console.warn('‚ö†Ô∏è Google Directions –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç, fallback', status);
                                calculateSimpleRoute();
                            }
                        });
                    }
                });

                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∏ Directions –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç: —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ –≤ –ö–†, –±–µ–∑ Plus Codes
        function initCustomAutocomplete(bounds) {
            setupInputAutocomplete('origin-address', 'origin', bounds);
            setupInputAutocomplete('destination-address', 'destination', bounds);
        }

        function setupInputAutocomplete(inputId, type, bounds) {
            const input = document.getElementById(inputId);
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä—è–º–æ –ø–æ–¥ –∏–Ω–ø—É—Ç–æ–º
            const wrapper = input.parentElement; // .main__order-details-item –∏–º–µ–µ—Ç position: relative
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            wrapper.appendChild(dropdown);

            let lastRequestId = 0;

            input.addEventListener('input', function() {
                const query = input.value.trim();
                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    dropdown.innerHTML = '';
                    return;
                }
                const requestId = ++lastRequestId;
                placesAutocompleteService.getPlacePredictions({
                    input: query,
                    bounds: bounds,
                    componentRestrictions: { country: 'kg' },
                    // –í–∞—Ä–∏–∞–Ω—Ç —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤
                    types: ['address']
                }, function(predictions, status) {
                    if (requestId !== lastRequestId) return;
                    if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
                        dropdown.style.display = 'none';
                        dropdown.innerHTML = '';
                        return;
                    }
                    // –§–∏–ª—å—Ç—Ä Plus Codes –∏ –≤—Å–µ–≥–æ, —á—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ–¥
                    const filtered = predictions.filter(p => {
                        const isPlus = (p.types && p.types.includes('plus_code')) || /\w{4}\+\w{2,}/i.test(p.structured_formatting?.main_text || '') || /\w{4}\+\w{2,}/i.test(p.description || '');
                        return !isPlus;
                    });
                    renderPredictions(dropdown, filtered, function(pred) {
                        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –º–µ—Å—Ç–∞ –∏ —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
                        placesDetailsService.getDetails({
                            placeId: pred.place_id,
                            fields: ['geometry', 'formatted_address']
                        }, function(place, detStatus) {
                            if (detStatus !== google.maps.places.PlacesServiceStatus.OK || !place || !place.geometry) return;
                            const loc = place.geometry.location;
                            const coords = { lat: loc.lat(), lng: loc.lng() };
                            input.value = place.formatted_address || pred.description;

                            // –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                            markers.forEach(m => m.setMap(null));
                            markers = [];

                            if (type === 'origin') {
                                firstPoint = coords;
                                if (originMarker) originMarker.setMap(null);
                                originMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#FF3B30', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                                selecting = secondPoint ? 'end' : 'b';
                            } else {
                                secondPoint = coords;
                                if (destinationMarker) destinationMarker.setMap(null);
                                destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#34C759', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                                selecting = firstPoint ? 'end' : 'a';
                            }

                            map.panTo(coords);
                            dropdown.style.display = 'none';
                            dropdown.innerHTML = '';
                            if (firstPoint && secondPoint) buildRoute();
                        });
                    });
                });
            });

            // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(ev) {
                if (!wrapper.contains(ev.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function renderPredictions(container, predictions, onSelect) {
            container.innerHTML = '';
            predictions.forEach(p => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = p.description;
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    onSelect(p);
                });
                container.appendChild(item);
            });
            container.style.display = predictions.length > 0 ? 'block' : 'none';
        }

        function buildRoute() {
            directionsService.route({
                origin: firstPoint,
                destination: secondPoint,
                travelMode: google.maps.TravelMode.DRIVING
            }, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                    const leg = response.routes[0].legs[0];
                    distance = (leg.distance && leg.distance.value ? leg.distance.value : 0) / 1000; // –∫–º
                    duration = (leg.duration && leg.duration.value ? leg.duration.value : 0) / 60; // –º–∏–Ω
                    updateRouteInfo();
                    calculatePrice();
                } else {
                    console.warn('‚ö†Ô∏è Google Directions –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç, fallback', status);
                    calculateSimpleRoute();
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
        function updateRouteInfo() {
            $('#distance').val(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`);
            $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω`);
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('üí∞ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –≤—ã–±—Ä–∞–Ω:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                $('#tariff-display').val(tariff);
                
                if (distance > 0 && duration > 0) {
                    const distancePrice = distance * tariffData.cityPricePerKm;
                    const timePrice = duration * tariffData.cityPricePerMinute;
                    
                    price += distancePrice + timePrice;
                    
                    console.log('üìä –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:', {
                        –ø–æ—Å–∞–¥–∫–∞: tariffData.boardingFee + ' —Å–æ–º',
                        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º √ó ' + tariffData.cityPricePerKm + ' = ' + distancePrice.toFixed(0) + ' —Å–æ–º',
                        –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω √ó ' + tariffData.cityPricePerMinute + ' = ' + timePrice.toFixed(0) + ' —Å–æ–º'
                    });
                }
                
                if (tariff === '–ë–∏–∑–Ω–µ—Å' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                }
                
                price = Math.ceil(price);
                
                $('#price').val(`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} —Å–æ–º`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`–ü–æ—Å–∞–¥–∫–∞: ${tariffData.boardingFee} —Å–æ–º`);
                
                console.log('‚úÖ –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞:', price + ' —Å–æ–º');
                
                return price;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã:', error);
                $('#price').val('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
                return 0;
            }
        }

        // Fallback —Ä–∞—Å—á–µ—Ç (–µ—Å–ª–∏ Directions API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        function calculateSimpleRoute() {
            if (firstPoint && secondPoint) {
                const lat1 = firstPoint.lat;
                const lng1 = firstPoint.lng;
                const lat2 = secondPoint.lat;
                const lng2 = secondPoint.lng;
                
                distance = calculateDistance(lat1, lng1, lat2, lng2);
                duration = (distance / 30) * 60; // 30 –∫–º/—á —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å
                
                console.log('üìè –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç:', {
                    distance: distance.toFixed(1) + ' –∫–º',
                    duration: duration.toFixed(0) + ' –º–∏–Ω'
                });
                
                updateRouteInfo();
                calculatePrice();
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
        function clearRoute() {
            selecting = 'a';
            firstPoint = undefined;
            secondPoint = undefined;
            distance = 0;
            duration = 0;
            
            if (directionsRenderer) {
                directionsRenderer.set('directions', null);
            }
            
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            if (originMarker) { originMarker.setMap(null); originMarker = null; }
            if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
            
            $('#origin-address').val('');
            $('#destination-address').val('');
            $('#distance').val('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º');
            $('#duration').val('–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω');
            $('#price').val('–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º');
            $('#calculated-price').val('0');
            
            console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        $(window).on('load', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
            setTimeout(function() {
                try {
                    initMap();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                }
            }, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
                const tariff = $(this).val();
                console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        $('#clear-markers-btn').click(function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                clearRoute();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            
            if (!driverId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
                return false;
            }
            if (!tariff) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
                return false;
            }
            if (!paymentMethod) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
                return false;
            }
            if (!origin) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
                return false;
            }
            if (!destination) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
                return false;
            }
            
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function(response) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    window.location.href = '/disp/';
                },
                error: function(error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (error.responseJSON ? error.responseJSON.detail : '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º'));
                }
            });
        });
        
        $('#cancel-btn').click(function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?')) {
                window.location.href = '/disp/';
            }
        });
        
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2
                e.preventDefault();
                window.location.reload();
            }
        });
    }

    // –û–±—Ä–∞—Ç–Ω–∞—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∫–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –∞–¥—Ä–µ—Å) —á–µ—Ä–µ–∑ Google Geocoder
    async function getAddressByCoordinates(lat, lon, type) {
        try {
            if (!(window.google && window.google.maps)) return;
            const geocoder = new google.maps.Geocoder();
            const result = await geocoder.geocode({ location: { lat: lat, lng: lon } });
            const data = Array.isArray(result.results) && result.results.length > 0 ? result.results[0].formatted_address : null;
            if (data) {
                if (type === 'origin') {
                    $('#origin-address').val(data);
                } else if (type === 'destination') {
                    $('#destination-address').val(data);
                }
            } else {
                const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                if (type === 'origin') $('#origin-address').val(coordsStr);
                if (type === 'destination') $('#destination-address').val(coordsStr);
            }
        } catch (error) {
            const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            if (type === 'origin') $('#origin-address').val(coordsStr);
            if (type === 'destination') $('#destination-address').val(coordsStr);
        }
    }
</script>
<style>
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .main__order-wrapper {
        border-radius: 5px;
    }
    .main__order-header {
        flex-wrap: wrap;
    }
    .main__btn {
        padding: 12px 30px;
    }
    .main__order-subheader {
        gap: 20px;
        flex-wrap: wrap;
    }
    .main__order-subheader-item {
        width: 100%;
    } 
    .main__subheader-filing {
        width: 100%;
    }
    #tariff-select,
    #payment-method {
        width: 100%;
    }
    .main__order-subheader-item .main__btn-short {
        width: 100%;
    }
    .main__order-notes {
        width: 100%;
        display: flex;
        justify-content: space-between;
    } 
    .main__order-notes-text {
        width: 65%;
    }
    @media (max-width: 1200px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        .main__order-settings, .main__order-map {
            width: 100%;
            margin-bottom: 20px;
        }
        .main__header-tags ul li {
            padding: 10px 15px;
        }
    }
    
    @media (max-width: 768px) {
        .main__header {
            flex-direction: column;
            align-items: flex-start;
        }
        .main__header-logo, .main__header-tags, .main__header-search {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__subheader-add {
            flex-wrap: wrap;
        }
        .main__order-header, .main__order-subheader {
            flex-direction: column;
        }
        .main__order-header-item, .main__order-subheader-item {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-details-item {
            flex-direction: column;
        }
        .main__order-details-item input {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-map-item {
            height: 300px;
        }
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∏–ª–µ–π */
    .main__order-map-item {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main__btn, .main__btn-short, .main__btn-green {
        transition: all 0.3s ease;
    }
    
    .main__btn:hover, .main__btn-short:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__btn-green:hover {
        background-color: #35a63a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__order-notes-text textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        resize: vertical;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∞ */
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .route-info-item {
        background-color: #47484c;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .route-info-item input {
        width: 90%;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #2d2e33;
        border: 1px solid #47484c;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        color: #fff;
        border-bottom: 1px solid #47484c;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #47484c;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    /* –ü—Ä—è—á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Google Places dropdown (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π) */
    .pac-container { display: none !important; }

    /* –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–æ–≤ */
    .main__order-details-item {
        position: relative;
    }
    
    @media (max-width: 576px) {
        .route-info-item {
            width: 100%;
        }
    }
</style>
{% endblock %}