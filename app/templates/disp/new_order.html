{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<style>
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .route-info-item input{
        background: transparent;
    } 
    .route-info-item input:hover {
        background: transparent;
        box-shadow: unset !important;
        transform: unset !important;
    }
</style>
<!-- <div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="–ü–æ–∏—Å–∫">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div> -->
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks" style="gap: 20px;">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>–ó–∞–∫–∞–∑ ‚Ññ</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–î–∞—Ç–∞ –≤—Ä–µ–º—è <span id="time-indicator" style="color: #28a745; font-size: 12px;">üá∞üá¨ LIVE</span></p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M:%S') }}" style="font-weight: 600; color: #28a745;">
                    </div>
                    <div class="main__order-header-item">
                        <p>–ü—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>–í–∞—Ä–∏–∞–Ω—Ç</option>
                                <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç+">–ö–æ–º—Ñ–æ—Ä—Ç+</option>
                                <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>–û–ø–ª–∞—Ç–∞</option>
                                <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="–ù–∞ –∫–∞—Ä—Ç—É">–ù–∞ –∫–∞—Ä—Ç—É</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)" class="main__btn" style="width: 100%;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"/>
                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <input type="hidden" id="origin-lat" name="origin_lat" value="">
                        <input type="hidden" id="origin-lng" name="origin_lng" value="">
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)" class="main__btn" style="width: 100%;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"/>
                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç–æ—á–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è -->
                        <input type="hidden" id="destination-lat" name="destination_lat" value="">
                        <input type="hidden" id="destination-lng" name="destination_lng" value="">
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
                    </div>
                    <div class="main__order-notes-settings" style="margin: 0 0 0 10px;">
                        <button type="button" class="main__btn-short">–ó–∞–∫–∞–∑ –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É</button>
                        <button type="button" class="main__btn-short">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>–ó–∞–∫–∞–∑</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–û—Ç–∫—É–¥–∞</th>
                                <th>–ö—É–¥–∞</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–∞—Ö</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map">
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã -->
                    <div id="map-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; background: #2d2e33; color: #fff; text-align: center;">
                        <div>
                            <div style="border: 4px solid #47484c; border-top: 4px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                            <h3>üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</h3>
                            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                        </div>
                    </div>
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Å—á–µ—Ç–∞</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="–≠–∫–æ–Ω–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="–ü–æ—Å–∞–¥–∫–∞: 48 —Å–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button type="button" id="cancel-btn" class="main__btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Google Maps JS API —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π -->
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è callback –¥–ª—è Google Maps
    window.initGoogleMaps = function() {
        console.log('‚úÖ Google Maps API –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        
            if (typeof $ !== 'undefined') {
            initApp();
            } else {
            // –ñ–¥–µ–º jQuery –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            const checkJQuery = setInterval(() => {
                if (typeof $ !== 'undefined') {
                    clearInterval(checkJQuery);
                    initApp();
                }
            }, 50);
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ Google Maps
    window.gm_authFailure = function() {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Google Maps API');
        showMapError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã: –ø—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º');
    };

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    function showMapError(message) {
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingIndicator = document.getElementById('map-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            mapContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #2d2e33; color: #fff; text-align: center; padding: 20px; border-radius: 8px;">
                    <div>
                        <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ Google Maps —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    function loadGoogleMaps() {
        try {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key or '' }}&libraries=places&loading=async&callback=initGoogleMaps&v=weekly`;
            script.async = true;
            script.defer = true;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
            script.onerror = function() {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Google Maps API');
                showMapError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Google Maps API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            };

            // –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
            const timeout = setTimeout(() => {
                if (!window.google || !window.google.maps) {
                    console.error('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ Google Maps API');
                    showMapError('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                }
            }, 10000); // 10 —Å–µ–∫—É–Ω–¥

            // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            script.onload = function() {
                clearTimeout(timeout);
            };

            document.head.appendChild(script);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ Google Maps:', error);
            showMapError('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã.');
        }
    }

    // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É Google Maps...');
        console.log('üîë Google API Key –≤ —à–∞–±–ª–æ–Ω–µ:', "{{ google_api_key or '–ù–ï–¢ –ö–õ–Æ–ß–ê' }}");
        console.log('üîë –î–ª–∏–Ω–∞ –∫–ª—é—á–∞:', "{{ google_api_key|length if google_api_key else 0 }}");
        loadGoogleMaps();
    });

    function initApp() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Google Maps');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å jQuery
        if (typeof $ === 'undefined') {
            console.error('‚ùå jQuery –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            showMapError('–û—à–∏–±–∫–∞: jQuery –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å Google Maps
        if (!window.google || !window.google.maps) {
            console.error('‚ùå Google Maps API –Ω–µ –≥–æ—Ç–æ–≤');
            showMapError('–û—à–∏–±–∫–∞: Google Maps API –Ω–µ –≥–æ—Ç–æ–≤');
            return;
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let placesAutocompleteService;
        let placesDetailsService;
        let firstPoint;
        let secondPoint;
        let selecting = 'a';
        let markers = [];
        let originMarker = null;
        let destinationMarker = null;
        let distance = 0;
        let duration = 0;
        
        // –¢–∞—Ä–∏—Ñ—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const TARIFFS = {
            '–≠–∫–æ–Ω–æ–º': {
                boardingFee: 50,
                cityPricePerKm: 15,
                cityPricePerMinute: 0.5,
                minimumPrice: 50
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç': {
                boardingFee: 80,
                cityPricePerKm: 20,
                cityPricePerMinute: 0.8,
                minimumPrice: 80
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç+': {
                boardingFee: 100,
                cityPricePerKm: 25,
                cityPricePerMinute: 1.0,
                minimumPrice: 100
            },
            '–ë–∏–∑–Ω–µ—Å': {
                boardingFee: 150,
                cityPricePerKm: 35,
                cityPricePerMinute: 1.5,
                minimumPrice: 150
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Maps —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        function initMap() {
            try {
                console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Google...');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    throw new Error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Google Maps API
                if (!window.google || !window.google.maps) {
                    throw new Error('Google Maps API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                const center = { lat: 40.5138, lng: 72.8019 };
                // –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
                const KG_BOUNDS = new google.maps.LatLngBounds(
                    new google.maps.LatLng(39.172, 69.227), // SW (—é–≥–æ-–∑–∞–ø–∞–¥)
                    new google.maps.LatLng(43.260, 80.283)  // NE (—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫)
                );
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                const KG_LAT_MIN = 39.172;
                const KG_LAT_MAX = 43.260;
                const KG_LNG_MIN = 69.227;
                const KG_LNG_MAX = 80.283;

                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                map = new google.maps.Map(mapContainer, {
                    center: center,
                    zoom: 12,
                    restriction: { latLngBounds: KG_BOUNDS, strictBounds: false },
                    gestureHandling: 'greedy',
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
                if (!map) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–∞—Ä—Ç—ã');
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
                directionsRenderer.setMap(map);
                geocoder = new google.maps.Geocoder();
                
                console.log('‚úÖ Google Maps –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –°–µ—Ä–≤–∏—Å—ã Places —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                try {
                placesAutocompleteService = new google.maps.places.AutocompleteService();
                placesDetailsService = new google.maps.places.PlacesService(map);
                    console.log('‚úÖ Places API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (placesError) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Places API:', placesError);
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ Places API
                }

                // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∞–¥—Ä–µ—Å–æ–≤
                initCustomAutocomplete(KG_BOUNDS);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.addListener('click', function(e) {
                    const latLng = e.latLng;
                    const coords = { lat: latLng.lat(), lng: latLng.lng() };
                    
                    if (selecting !== 'end') {
                        const marker = new google.maps.Marker({
                            position: coords,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 6,
                                fillColor: selecting === 'a' ? '#FF3B30' : '#34C759',
                                fillOpacity: 1,
                                strokeColor: '#FFFFFF',
                                strokeWeight: 2
                            }
                        });
                        markers.push(marker);
                    }

                    if (selecting === 'a') {
                        firstPoint = coords;
                        if (originMarker) originMarker.setMap(null);
                        originMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#FF3B30', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                        selecting = 'b';
                        
                        // –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –¢–û–ß–ö–ò A –í –°–ö–†–´–¢–´–ï –ü–û–õ–Ø
                        document.getElementById('origin-lat').value = coords.lat;
                        document.getElementById('origin-lng').value = coords.lng;
                        console.log('üìç –¢–æ—á–∫–∞ A —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', coords);
                        
                        getAddressByCoordinates(coords.lat, coords.lng, 'origin');
                    } else if (selecting === 'b') {
                        secondPoint = coords;
                        if (destinationMarker) destinationMarker.setMap(null);
                        destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#34C759', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                        selecting = 'end';
                        
                        // –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –¢–û–ß–ö–ò B –í –°–ö–†–´–¢–´–ï –ü–û–õ–Ø
                        document.getElementById('destination-lat').value = coords.lat;
                        document.getElementById('destination-lng').value = coords.lng;
                        console.log('üìç –¢–æ—á–∫–∞ B —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', coords);
                        
                        getAddressByCoordinates(coords.lat, coords.lng, 'destination');
                    }

                    if (firstPoint && secondPoint) {
                        directionsService.route({
                            origin: firstPoint,
                            destination: secondPoint,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, function(response, status) {
                            if (status === google.maps.DirectionsStatus.OK) {
                                directionsRenderer.setDirections(response);
                                const leg = response.routes[0].legs[0];
                                distance = (leg.distance && leg.distance.value ? leg.distance.value : 0) / 1000; // –∫–º
                                duration = (leg.duration && leg.duration.value ? leg.duration.value : 0) / 60; // –º–∏–Ω
                                updateRouteInfo();
                                calculatePrice();
                            } else {
                                console.warn('‚ö†Ô∏è Google Directions –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç, fallback', status);
                                calculateSimpleRoute();
                            }
                        });
                    }
                });

                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∏ Directions –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingIndicator = document.getElementById('map-loading');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
                showMapError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                return false;
            }
            
            return true;
        }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç: —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ –≤ –ö–†, –±–µ–∑ Plus Codes
        function initCustomAutocomplete(bounds) {
            try {
                if (placesAutocompleteService && placesDetailsService) {
            setupInputAutocomplete('origin-address', 'origin', bounds);
            setupInputAutocomplete('destination-address', 'destination', bounds);
                    console.log('‚úÖ –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∞–¥—Ä–µ—Å–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } else {
                    console.warn('‚ö†Ô∏è Places API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –æ—Ç–∫–ª—é—á–µ–Ω');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞:', error);
            }
        }

        function setupInputAutocomplete(inputId, type, bounds) {
            const input = document.getElementById(inputId);
            if (!input) {
                console.error(`‚ùå –≠–ª–µ–º–µ–Ω—Ç ${inputId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            if (!placesAutocompleteService) {
                console.warn(`‚ö†Ô∏è AutocompleteService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è ${inputId}`);
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä—è–º–æ –ø–æ–¥ –∏–Ω–ø—É—Ç–æ–º
            const wrapper = input.parentElement; // .main__order-details-item –∏–º–µ–µ—Ç position: relative
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            wrapper.appendChild(dropdown);

            let lastRequestId = 0;

            input.addEventListener('input', function() {
                const query = input.value.trim();
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    dropdown.innerHTML = '';
                    return;
                }
                const requestId = ++lastRequestId;
                console.log(`üîç –ü–æ–∏—Å–∫ –¥–ª—è "${query}" (—Ç–∏–ø: ${type})...`);
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const mapBounds = map ? map.getBounds() : bounds;
                
                placesAutocompleteService.getPlacePredictions({
                    input: query,
                    bounds: mapBounds,
                    location: map ? map.getCenter() : { lat: 40.5138, lng: 72.8019 },
                    radius: 50000, // 50–∫–º —Ä–∞–¥–∏—É—Å –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                    componentRestrictions: { country: 'kg' },
                    // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã –∑–∞–≤–µ–¥–µ–Ω–∏–π –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ
                    types: ['establishment', 'geocode']
                }, function(predictions, status) {
                    if (requestId !== lastRequestId) return;
                    if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
                        dropdown.style.display = 'none';
                        dropdown.innerHTML = '';
                        return;
                    }
                    // –°—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ
                    const filtered = predictions.filter(p => {
                        // –ò—Å–∫–ª—é—á–∞–µ–º Plus Codes
                        const isPlus = (p.types && p.types.includes('plus_code')) || /\w{4}\+\w{2,}/i.test(p.structured_formatting?.main_text || '') || /\w{4}\+\w{2,}/i.test(p.description || '');
                        if (isPlus) return false;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–¥—Ä–µ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω
                        const description = (p.description || '').toLowerCase();
                        const mainText = (p.structured_formatting?.main_text || '').toLowerCase();
                        const secondaryText = (p.structured_formatting?.secondary_text || '').toLowerCase();
                        
                        const isInKyrgyzstan = description.includes('–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω') || 
                                             description.includes('kyrgyzstan') || 
                                             description.includes('–∫–≥') ||
                                             secondaryText.includes('–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω') || 
                                             secondaryText.includes('kyrgyzstan') ||
                                             // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –ö–†
                                             description.includes('–±–∏—à–∫–µ–∫') || description.includes('bishkek') ||
                                             description.includes('–æ—à') || description.includes('osh') ||
                                             description.includes('–¥–∂–∞–ª–∞–ª-–∞–±–∞–¥') || description.includes('jalal-abad') ||
                                             description.includes('–∫–∞—Ä–∞–∫–æ–ª') || description.includes('karakol') ||
                                             description.includes('–Ω–∞—Ä—ã–Ω') || description.includes('naryn') ||
                                             description.includes('—Ç–∞–ª–∞—Å') || description.includes('talas') ||
                                             description.includes('–±–∞—Ç–∫–µ–Ω') || description.includes('batken');
                                             
                        return isInKyrgyzstan;
                    });
                    
                    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ª–æ, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
                    if (filtered.length < 3) {
                        console.log('üîç –ú–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫...');
                        placesAutocompleteService.getPlacePredictions({
                            input: query,
                            bounds: mapBounds,
                            location: map ? map.getCenter() : { lat: 40.5138, lng: 72.8019 },
                            radius: 100000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å –¥–æ 100–∫–º
                            componentRestrictions: { country: 'kg' },
                            // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–∏–ø—ã –º–µ—Å—Ç
                            types: ['establishment', 'point_of_interest', 'premise', 'subpremise', 'route', 'locality']
                        }, function(additionalPredictions, additionalStatus) {
                            if (additionalStatus === google.maps.places.PlacesServiceStatus.OK && additionalPredictions) {
                                const additionalFiltered = additionalPredictions.filter(p => {
                                    const isPlus = (p.types && p.types.includes('plus_code')) || /\w{4}\+\w{2,}/i.test(p.structured_formatting?.main_text || '') || /\w{4}\+\w{2,}/i.test(p.description || '');
                                    if (isPlus) return false;
                                    
                                    const description = (p.description || '').toLowerCase();
                                    const secondaryText = (p.structured_formatting?.secondary_text || '').toLowerCase();
                                    
                                    return description.includes('–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω') || description.includes('kyrgyzstan') || 
                                           secondaryText.includes('–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω') || secondaryText.includes('kyrgyzstan') ||
                                           description.includes('–±–∏—à–∫–µ–∫') || description.includes('osh') || description.includes('–æ—à');
                                });
                                
                                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                                const allResults = [...filtered];
                                additionalFiltered.forEach(item => {
                                    if (!allResults.find(existing => existing.place_id === item.place_id)) {
                                        allResults.push(item);
                                    }
                                });
                                
                                console.log(`üìç –ù–∞–π–¥–µ–Ω–æ ${allResults.length} –º–µ—Å—Ç –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ`);
                                renderPredictions(dropdown, allResults, predictionHandler);
                            } else {
                                renderPredictions(dropdown, filtered, predictionHandler);
                            }
                        });
                    } else {
                        console.log(`üìç –ù–∞–π–¥–µ–Ω–æ ${filtered.length} –º–µ—Å—Ç –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ`);
                        renderPredictions(dropdown, filtered, predictionHandler);
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
                    function predictionHandler(pred) {
                        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –º–µ—Å—Ç–∞ –∏ —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
                        placesDetailsService.getDetails({
                            placeId: pred.place_id,
                            fields: ['geometry', 'formatted_address']
                        }, function(place, detStatus) {
                            if (detStatus !== google.maps.places.PlacesServiceStatus.OK || !place || !place.geometry) return;
                            const loc = place.geometry.location;
                            const coords = { lat: loc.lat(), lng: loc.lng() };
                            
                            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç - —Å—Ç—Ä–æ–≥–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
                            if (coords.lat < 39.172 || coords.lat > 43.260 || coords.lng < 69.227 || coords.lng > 80.283) {
                                console.warn('‚ö†Ô∏è –ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞:', coords);
                                return;
                            }
                            
                            input.value = place.formatted_address || pred.description;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                            if (inputId === 'origin-address') {
                                document.getElementById('origin-lat').value = coords.lat;
                                document.getElementById('origin-lng').value = coords.lng;
                                console.log('üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', coords.lat, coords.lng);
                            } else if (inputId === 'destination-address') {
                                document.getElementById('destination-lat').value = coords.lat;
                                document.getElementById('destination-lng').value = coords.lng;
                                console.log('üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', coords.lat, coords.lng);
                            }
                                
                            // –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                            markers.forEach(m => m.setMap(null));
                            markers = [];

                            if (type === 'origin') {
                                firstPoint = coords;
                                if (originMarker) originMarker.setMap(null);
                                originMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#FF3B30', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                                selecting = secondPoint ? 'end' : 'b';
                } else {
                                secondPoint = coords;
                                if (destinationMarker) destinationMarker.setMap(null);
                                destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#34C759', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 2 } });
                                selecting = firstPoint ? 'end' : 'a';
                            }

                            map.panTo(coords);
                            dropdown.style.display = 'none';
                            dropdown.innerHTML = '';
                            if (firstPoint && secondPoint) buildRoute();
                        });
                    }
                });
            });

            // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(ev) {
                if (!wrapper.contains(ev.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function renderPredictions(container, predictions, onSelect) {
            container.innerHTML = '';
            predictions.forEach(p => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Ç–∏–ø–∞ –º–µ—Å—Ç–∞
                const mainText = document.createElement('div');
                mainText.style.fontWeight = 'bold';
                mainText.textContent = p.structured_formatting?.main_text || p.description;
                
                const secondaryText = document.createElement('div');
                secondaryText.style.fontSize = '12px';
                secondaryText.style.color = '#aaa';
                secondaryText.style.marginTop = '2px';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ—Å—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                let placeType = '';
                if (p.types) {
                    if (p.types.includes('establishment')) placeType = 'üè¢ –ó–∞–≤–µ–¥–µ–Ω–∏–µ';
                    else if (p.types.includes('point_of_interest')) placeType = 'üìç –î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å';
                    else if (p.types.includes('route')) placeType = 'üõ£Ô∏è –£–ª–∏—Ü–∞';
                    else if (p.types.includes('locality')) placeType = 'üèòÔ∏è –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç';
                    else if (p.types.includes('premise')) placeType = 'üè† –ó–¥–∞–Ω–∏–µ';
                    else placeType = 'üìç –ú–µ—Å—Ç–æ';
                }
                
                const locationText = p.structured_formatting?.secondary_text || '';
                secondaryText.textContent = `${placeType} ‚Ä¢ ${locationText}`;
                
                item.appendChild(mainText);
                item.appendChild(secondaryText);
                
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    onSelect(p);
                });
                container.appendChild(item);
            });
            container.style.display = predictions.length > 0 ? 'block' : 'none';
        }

        function buildRoute() {
            directionsService.route({
                origin: firstPoint,
                destination: secondPoint,
                travelMode: google.maps.TravelMode.DRIVING
            }, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                    const leg = response.routes[0].legs[0];
                    distance = (leg.distance && leg.distance.value ? leg.distance.value : 0) / 1000; // –∫–º
                    duration = (leg.duration && leg.duration.value ? leg.duration.value : 0) / 60; // –º–∏–Ω
                    updateRouteInfo();
                    calculatePrice();
                } else {
                    console.warn('‚ö†Ô∏è Google Directions –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç, fallback', status);
                    calculateSimpleRoute();
            }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
        function updateRouteInfo() {
            $('#distance').val(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`);
            $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω`);
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('üí∞ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –≤—ã–±—Ä–∞–Ω:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                $('#tariff-display').val(tariff);
                
                if (distance > 0 && duration > 0) {
                    const distancePrice = distance * tariffData.cityPricePerKm;
                    const timePrice = duration * tariffData.cityPricePerMinute;
                    
                    price += distancePrice + timePrice;
                    
                    console.log('üìä –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:', {
                        –ø–æ—Å–∞–¥–∫–∞: tariffData.boardingFee + ' —Å–æ–º',
                        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º √ó ' + tariffData.cityPricePerKm + ' = ' + distancePrice.toFixed(0) + ' —Å–æ–º',
                        –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω √ó ' + tariffData.cityPricePerMinute + ' = ' + timePrice.toFixed(0) + ' —Å–æ–º'
                    });
                }
                
                if (tariff === '–ë–∏–∑–Ω–µ—Å' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                }
                
                price = Math.ceil(price);
                
                $('#price').val(`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} —Å–æ–º`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`–ü–æ—Å–∞–¥–∫–∞: ${tariffData.boardingFee} —Å–æ–º`);
                
                console.log('‚úÖ –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞:', price + ' —Å–æ–º');
                
                return price;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã:', error);
                $('#price').val('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
                return 0;
            }
        }

        // Fallback —Ä–∞—Å—á–µ—Ç (–µ—Å–ª–∏ Directions API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        function calculateSimpleRoute() {
            if (firstPoint && secondPoint) {
                const lat1 = firstPoint.lat;
                const lng1 = firstPoint.lng;
                const lat2 = secondPoint.lat;
                const lng2 = secondPoint.lng;
                
                distance = calculateDistance(lat1, lng1, lat2, lng2);
                duration = (distance / 30) * 60; // 30 –∫–º/—á —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å
                
                console.log('üìè –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç:', {
                    distance: distance.toFixed(1) + ' –∫–º',
                    duration: duration.toFixed(0) + ' –º–∏–Ω'
                });
                
                updateRouteInfo();
                calculatePrice();
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
        function clearRoute() {
            selecting = 'a';
            firstPoint = undefined;
            secondPoint = undefined;
            distance = 0;
            duration = 0;
            
            if (directionsRenderer) {
                directionsRenderer.set('directions', null);
            }
            
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            if (originMarker) { originMarker.setMap(null); originMarker = null; }
            if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
            
            $('#origin-address').val('');
            $('#destination-address').val('');
            $('#origin-lat').val('');
            $('#origin-lng').val('');
            $('#destination-lat').val('');
            $('#destination-lng').val('');
            $('#distance').val('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º');
            $('#duration').val('–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω');
            $('#price').val('–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º');
            $('#calculated-price').val('0');
            
            console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ callback Google Maps)
        function startMapInitialization() {
            console.log('üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã...');
            try {
                const success = initMap();
                if (success) {
                    console.log('‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                } else {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É');
                }
                } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
                showMapError(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
                const tariff = $(this).val();
                console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        $('#clear-markers-btn').click(function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                clearRoute();
            }
        });
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ö–û–û–†–î–ò–ù–ê–¢ –ü–†–ò –í–í–û–î–ï –ê–î–†–ï–°–û–í
        $('#origin-address').on('input blur', function() {
            const address = $(this).val();
            if (address && address.length > 3) {
                extractAndSetCoordinatesFromAddress(address, 'origin');
            }
        });

        $('#destination-address').on('input blur', function() {
            const address = $(this).val();
            if (address && address.length > 3) {
                extractAndSetCoordinatesFromAddress(address, 'destination');
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ –∞–¥—Ä–µ—Å–∞ —Å Plus –∫–æ–¥–æ–º
        function extractAndSetCoordinatesFromAddress(address, type) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ Plus –∫–æ–¥ –≤ –∞–¥—Ä–µ—Å–µ
            const plusCodeMatch = address.toUpperCase().match(/([A-Z0-9]{4}\+[A-Z0-9]{2,3})/);
            if (plusCodeMatch) {
                const plusCode = plusCodeMatch[1];
                console.log('üìç Plus –∫–æ–¥ –Ω–∞–π–¥–µ–Ω –≤ –∞–¥—Ä–µ—Å–µ:', plusCode);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Plus Codes API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (window.google && window.google.maps && window.google.maps.geometry) {
                    try {
                        // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å Plus –∫–æ–¥
                        const latLng = window.google.maps.geometry.OpenLocationCode.decode(plusCode);
                        const coords = {
                            lat: latLng.latLo + (latLng.latHi - latLng.latLo) / 2,
                            lng: latLng.lngLo + (latLng.lngHi - latLng.lngLo) / 2
                        };
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                        if (type === 'origin') {
                            document.getElementById('origin-lat').value = coords.lat;
                            document.getElementById('origin-lng').value = coords.lng;
                            console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ A –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ Plus –∫–æ–¥–∞:', coords);
                        } else if (type === 'destination') {
                            document.getElementById('destination-lat').value = coords.lat;
                            document.getElementById('destination-lng').value = coords.lng;
                            console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ B –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ Plus –∫–æ–¥–∞:', coords);
                        }
                        return;
                    } catch (error) {
                        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è Plus –∫–æ–¥–∞:', error);
                    }
                }
                
                // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞–ø–ø–∏–Ω–≥–∏
                const coords = getFallbackCoordinatesForPlusCode(plusCode);
                if (coords.lat && coords.lng) {
                    if (type === 'origin') {
                        document.getElementById('origin-lat').value = coords.lat;
                        document.getElementById('origin-lng').value = coords.lng;
                        console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ A (fallback):', coords);
                    } else if (type === 'destination') {
                        document.getElementById('destination-lat').value = coords.lat;
                        document.getElementById('destination-lng').value = coords.lng;
                        console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ B (fallback):', coords);
                    }
                }
            }
        }

        // Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö Plus –∫–æ–¥–æ–≤
        function getFallbackCoordinatesForPlusCode(plusCode) {
            // –ë–∞–∑–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
            if (plusCode.startsWith('HQ') || plusCode.startsWith('JR') || plusCode.startsWith('JQ')) {
                // –¢–∞—à–∫–µ–Ω—Ç/–ì–∞–∑–∞–ª–∫–µ–Ω—Ç, –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω
                return { lat: 41.62 + (Math.random() - 0.5) * 0.01, lng: 69.92 + (Math.random() - 0.5) * 0.01 };
            } else if (plusCode.startsWith('GP') || plusCode.startsWith('GQ')) {
                // –û—à, –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω
                return { lat: 40.51 + (Math.random() - 0.5) * 0.01, lng: 72.80 + (Math.random() - 0.5) * 0.01 };
            } else if (plusCode.startsWith('5H') || plusCode.startsWith('6H') || plusCode.startsWith('7H') || plusCode.startsWith('8H') || plusCode.startsWith('9H')) {
                // –†–∞–∑–ª–∏—á–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
                return { lat: 41.20 + (Math.random() - 0.5) * 0.1, lng: 74.50 + (Math.random() - 0.5) * 0.1 };
            } else if (plusCode.startsWith('9M') || plusCode.startsWith('9J') || plusCode.startsWith('9Q') || plusCode.startsWith('XR')) {
                // –§–µ—Ä–≥–∞–Ω–∞, –ù–∞–º–∞–Ω–≥–∞–Ω –∏ –¥—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞
                return { lat: 40.35 + (Math.random() - 0.5) * 0.1, lng: 71.78 + (Math.random() - 0.5) * 0.1 };
            } else if (plusCode.startsWith('XH') || plusCode.startsWith('4')) {
                // –î—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã
                return { lat: 41.00 + (Math.random() - 0.5) * 0.2, lng: 71.00 + (Math.random() - 0.5) * 0.2 };
            }
            
            return { lat: null, lng: null };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            const originLat = $('#origin-lat').val();
            const originLng = $('#origin-lng').val();
            const destinationLat = $('#destination-lat').val();
            const destinationLng = $('#destination-lng').val();
            const orderNumber = $('#order-number').val();
            const orderDate = $('#order-date').val();
            const orderTime = $('#order-time').val();
            const routeNumber = $('#route-number').val();
            const notes = $('#notes').val();
            const calculatedPrice = $('#calculated-price').val();
            
            // –í–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≤—ã–±—Ä–∞–Ω - –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            // if (!driverId) {
            //     alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
            //     return false;
            // }
            if (!tariff) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
                return false;
            }
            if (!paymentMethod) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
                return false;
            }
            if (!origin || origin.trim() === '') {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
                return false;
            }
            if (!destination || destination.trim() === '') {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
                return false;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
            if (!orderNumber || orderNumber.trim() === '') {
                alert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞');
                return false;
            }
            
            if (!orderDate || orderDate.trim() === '') {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∑–∞–∫–∞–∑–∞');
                return false;
            }
            
            if (!orderTime || orderTime.trim() === '') {
                alert('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞');
                return false;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const formData = new FormData();
            formData.append('order_number', orderNumber || '');
            formData.append('order_date', orderDate || '');
            formData.append('order_time', orderTime || '');
            formData.append('route_number', routeNumber || '');
            formData.append('driver_id', driverId || ''); // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω
            formData.append('tariff', tariff || '');
            formData.append('payment_method', paymentMethod || '');
            formData.append('origin', origin.trim());
            formData.append('destination', destination.trim());
            formData.append('origin_lat', originLat || '');
            formData.append('origin_lng', originLng || '');
            formData.append('destination_lat', destinationLat || '');
            formData.append('destination_lng', destinationLng || '');
            formData.append('notes', notes || '');
            formData.append('price', calculatedPrice || '0');
            
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞:', {
                order_number: orderNumber,
                driver_id: driverId || '–Ω–µ –≤—ã–±—Ä–∞–Ω',
                tariff: tariff,
                origin: origin,
                destination: destination,
                origin_coords: `${originLat || '–ù–ï–¢'},${originLng || '–ù–ï–¢'}`,
                destination_coords: `${destinationLat || '–ù–ï–¢'},${destinationLng || '–ù–ï–¢'}`,
                price: calculatedPrice || '0'
            });
            
            // –õ–æ–≥–∏—Ä—É–µ–º FormData –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            for (let [key, value] of formData.entries()) {
                console.log(`üìã ${key}: ${value}`);
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            fetch('/api/admin/orders/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorData);
                        let errorDetail = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                        
                        if (errorData.detail) {
                            errorDetail = errorData.detail;
                        } else if (errorData.message) {
                            errorDetail = errorData.message;
                        } else if (typeof errorData === 'string') {
                            errorDetail = errorData;
                        } else {
                            errorDetail = JSON.stringify(errorData);
                        }
                        
                        throw new Error(errorDetail);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`–ó–∞–∫–∞–∑ ${data.order_number} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
                    window.location.href = '/disp/';
                } else {
                    throw new Error(data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'object') {
                    errorMessage = JSON.stringify(error);
                } else {
                    errorMessage = String(error);
                }
                
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + errorMessage);
            });
        });
        
        $('#cancel-btn').click(function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?')) {
                window.location.href = '/disp/';
            }
        });
        
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2
                e.preventDefault();
                window.location.reload();
            }
        });
        
        // –ü—Ä–æ—Å—Ç–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (–±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–∏ üòÖ)
        function disableBrowserAutocomplete() {
            const addressInputs = ['origin-address', 'destination-address'];
            
            addressInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // –ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    input.setAttribute('autocomplete', 'new-password');
                    input.setAttribute('name', inputId + '-' + Math.random().toString(36).substr(2, 9));
                    
                    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞—Ç—Ä–∏–±—É—Ç–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ (–±–µ–∑ readonly!)
                    input.addEventListener('focus', function() {
                        this.setAttribute('autocomplete', 'new-password');
                    });
                }
            });
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –º—è–≥–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
        disableBrowserAutocomplete();
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TimeAPI –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
        initKyrgyzstanTime();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        startMapInitialization();
    }

    // üá∞üá¨ –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ —á–µ—Ä–µ–∑ TimeAPI
    function initKyrgyzstanTime() {
        console.log('üïê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞...');
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ TimeAPI
        async function fetchKyrgyzstanTime() {
            try {
                const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=Asia/Bishkek');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ TimeAPI:', error);
                // Fallback –Ω–∞ –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π –¥–ª—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
                const now = new Date();
                const kgTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bishkek"}));
                return {
                    dateTime: kgTime.toISOString(),
                    date: kgTime.toISOString().split('T')[0],
                    time: kgTime.toTimeString().split(' ')[0]
                };
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç—ã
        function updateTimeDisplay(timeData) {
            try {
                let dateTimeStr, dateStr, timeStr;
                
                if (timeData.dateTime) {
                    // –§–æ—Ä–º–∞—Ç TimeAPI
                    const dt = new Date(timeData.dateTime);
                    dateStr = dt.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit'
                    });
                    timeStr = dt.toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } else {
                    // Fallback —Ñ–æ—Ä–º–∞—Ç
                    dateStr = timeData.date;
                    timeStr = timeData.time;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
                $('#order-date').val(dateStr);
                $('#order-time').val(timeStr);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const indicator = $('#time-indicator');
                indicator.css('opacity', '0.5');
                setTimeout(() => indicator.css('opacity', '1'), 200);
                
                console.log(`üïê –í—Ä–µ–º—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${dateStr} ${timeStr}`);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                $('#time-indicator').text('‚ùå OFFLINE').css('color', '#dc3545');
            }
        }

        // –õ–æ–∫–∞–ª—å–Ω—ã–µ —á–∞—Å—ã (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –±–µ–∑ API –∑–∞–ø—Ä–æ—Å–æ–≤)
        function updateLocalTime() {
            try {
                const now = new Date();
                // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–∞—É–∑–µ—Ä–∞
                const kgTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bishkek"}));
                
                const dateStr = kgTime.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                
                const timeStr = kgTime.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                $('#order-date').val(dateStr);
                $('#order-time').val(timeStr);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —á–∞—Å–æ–≤:', error);
            }
        }

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        fetchKyrgyzstanTime().then(updateTimeDisplay);

        // –õ–æ–∫–∞–ª—å–Ω—ã–µ —á–∞—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (–±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API)
        setInterval(updateLocalTime, 1000);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å TimeAPI –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        setInterval(async () => {
            console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å TimeAPI...');
            const timeData = await fetchKyrgyzstanTime();
            updateTimeDisplay(timeData);
        }, 60000); // 60 —Å–µ–∫—É–Ω–¥

        console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞:');
        console.log('   üì∫ –õ–æ–∫–∞–ª—å–Ω—ã–µ —á–∞—Å—ã: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É');
        console.log('   üåê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å API: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É');
    }

    // –û–±—Ä–∞—Ç–Ω–∞—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∫–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –∞–¥—Ä–µ—Å) —á–µ—Ä–µ–∑ Google Geocoder
    async function getAddressByCoordinates(lat, lon, type) {
        try {
            if (!(window.google && window.google.maps)) return;
            const geocoder = new google.maps.Geocoder();
            const result = await geocoder.geocode({ location: { lat: lat, lng: lon } });
            const data = Array.isArray(result.results) && result.results.length > 0 ? result.results[0].formatted_address : null;
            if (data) {
                if (type === 'origin') {
                    $('#origin-address').val(data);
                } else if (type === 'destination') {
                    $('#destination-address').val(data);
                }
            } else {
                const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                if (type === 'origin') $('#origin-address').val(coordsStr);
                if (type === 'destination') $('#destination-address').val(coordsStr);
            }
        } catch (error) {
            const coordsStr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            if (type === 'origin') $('#origin-address').val(coordsStr);
            if (type === 'destination') $('#destination-address').val(coordsStr);
        }
    }
</script>
<style>
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .main__order-wrapper {
        border-radius: 5px;
    }
    .main__order-header {
        flex-wrap: wrap;
    }
    .main__btn {
        padding: 12px 30px;
    }
    .main__order-subheader {
        gap: 20px;
        flex-wrap: wrap;
    }
    .main__order-subheader-item {
        width: 100%;
    } 
    .main__subheader-filing {
        width: 100%;
    }
    #tariff-select,
    #payment-method {
        width: 100%;
    }
    .main__order-subheader-item .main__btn-short {
        width: 100%;
    }
    .main__order-notes {
        width: 100%;
        display: flex;
        justify-content: space-between;
    } 
    .main__order-notes-text {
        width: 65%;
    }
    @media (max-width: 1200px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        .main__order-settings, .main__order-map {
            width: 100%;
            margin-bottom: 20px;
        }
        .main__header-tags ul li {
            padding: 10px 15px;
        }
    }
    
    @media (max-width: 768px) {
        .main__header {
            flex-direction: column;
            align-items: flex-start;
        }
        .main__header-logo, .main__header-tags, .main__header-search {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__subheader-add {
            flex-wrap: wrap;
        }
        .main__order-header, .main__order-subheader {
            flex-direction: column;
        }
        .main__order-header-item, .main__order-subheader-item {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-details-item {
            flex-direction: column;
        }
        .main__order-details-item input {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-map-item {
            height: 300px;
        }
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∏–ª–µ–π */
    .main__order-map-item {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main__btn, .main__btn-short, .main__btn-green {
        transition: all 0.3s ease;
    }
    
    .main__btn:hover, .main__btn-short:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__btn-green:hover {
        background-color: #35a63a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__order-notes-text textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        resize: vertical;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∞ */
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .route-info-item {
        background-color: #47484c;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .route-info-item input {
        width: 90%;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #2d2e33;
        border: 1px solid #47484c;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 300px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        color: #fff;
        border-bottom: 1px solid #47484c;
        transition: all 0.2s ease;
        line-height: 1.4;
    }
    
    .autocomplete-item:hover {
        background-color: #47484c;
        transform: translateX(2px);
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ */
    .autocomplete-item div:first-child {
        font-weight: 600;
        margin-bottom: 4px;
        color: #ffffff;
    }
    
    .autocomplete-item div:last-child {
        font-size: 11px;
        color: #aaa;
        opacity: 0.8;
    }
    /* –ü—Ä—è—á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Google Places dropdown (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π) */
    .pac-container { display: none !important; }
    
    /* –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞ */
    input[type="text"]:-webkit-autofill,
    input[type="text"]:-webkit-autofill:hover,
    input[type="text"]:-webkit-autofill:focus,
    input[type="text"]:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px #2d2e33 inset !important;
        -webkit-text-fill-color: #fff !important;
        transition: background-color 5000s ease-in-out 0s;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º dropdown –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –±—Ä–∞—É–∑–µ—Ä–∞ */
    input[autocomplete]::-webkit-contacts-auto-fill-button,
    input[autocomplete]::-webkit-credentials-auto-fill-button {
        visibility: hidden;
        display: none !important;
        pointer-events: none;
        height: 0;
        width: 0;
        margin: 0;
    }
    
    /* –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */
    #origin-address::-webkit-list-button,
    #destination-address::-webkit-list-button {
        display: none;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–æ–≤ */
    .main__order-details-item {
        position: relative;
    }
    
    @media (max-width: 576px) {
        .route-info-item {
            width: 100%;
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∂–∏–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ */
    #time-indicator {
        transition: opacity 0.3s ease;
        font-weight: 600;
        text-shadow: 0 0 3px rgba(40, 167, 69, 0.3);
    }

    #order-time {
        font-family: 'Courier New', monospace !important;
        letter-spacing: 1px;
        text-align: center;
        background: linear-gradient(145deg, #2d2e33, #3a3b40) !important;
        border: 1px solid #28a745 !important;
        transition: all 0.2s ease;
    }

    #order-time:focus {
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3) !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    #map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        background: rgba(45, 46, 51, 0.95);
        backdrop-filter: blur(2px);
    }
</style>
{% endblock %}