{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - taxi.wazir.kg{% endblock %}

{% block header_title %}{% endblock %}

{% block header_right %}
<div class="main__header-search">
    <div class="main__header-search-item">
        <form action="#">
            <input type="search" placeholder="–ü–æ–∏—Å–∫">
            <button><img
                    src="{{ url_for('static', path='/assets/img/ico/search.png') }}"
                    alt="search"></button>
        </form>
    </div>
    <div class="main__header-search-profile">
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/notif.png') }}"
                    alt="notif"></a>
        </div>
        <div class="main__header-search-profile-item">
            <a href="#"><img
                    src="{{ url_for('static', path='/assets/img/ico/user.png') }}"
                    alt="profile"></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>–ó–∞–∫–∞–∑ ‚Ññ</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–î–∞—Ç–∞ –≤—Ä–µ–º—è</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>–ü—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>–í–∞—Ä–∏–∞–Ω—Ç</option>
                                <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç+">–ö–æ–º—Ñ–æ—Ä—Ç+</option>
                                <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>–û–ø–ª–∞—Ç–∞</option>
                                <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="–ù–∞ –∫–∞—Ä—Ç—É">–ù–∞ –∫–∞—Ä—Ç—É</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">–ó–∞–∫–∞–∑ –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É</button>
                        <button type="button" class="main__btn-short">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>–ó–∞–∫–∞–∑</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–û—Ç–∫—É–¥–∞</th>
                                <th>–ö—É–¥–∞</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–∞—Ö</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map">
                    <!-- 2–ì–ò–° –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—é–¥–∞ -->
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings" style="display: flex; justify-content: space-between; flex-direction: unset; gap: 20px;">
                        <button type="button" class="main__btn">–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Å—á–µ—Ç–∞</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="–≠–∫–æ–Ω–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="–ü–æ—Å–∞–¥–∫–∞: 48 —Å–æ–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="duration" readonly class="main__btn-short" value="–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button type="button" id="cancel-btn" class="main__btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ 2–ì–ò–° MapGL JS API -->
<script src="https://mapgl.2gis.com/api/js"></script>
<script>
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ jQuery
    document.addEventListener('DOMContentLoaded', function() {
        // –ñ–¥—ë–º —Ç–∞–∫–∂–µ –∑–∞–≥—Ä—É–∑–∫–∏ jQuery
        function waitForJQuery() {
            if (typeof $ !== 'undefined') {
                initApp();
            } else {
                setTimeout(waitForJQuery, 100);
            }
        }
        waitForJQuery();
    });

    function initApp() {
        console.log('jQuery –≥–æ—Ç–æ–≤');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        let map;
        let originMarker = null;
        let destinationMarker = null;
        let routeLayer = null;
        let originCoords = null;
        let destinationCoords = null;
        let distance = 0;
        let duration = 0;
        
        // –¢–∞—Ä–∏—Ñ—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const TARIFFS = {
            '–≠–∫–æ–Ω–æ–º': {
                boardingFee: 50,
                cityPricePerKm: 15,
                cityPricePerMinute: 0.5,
                minimumPrice: 50
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç': {
                boardingFee: 80,
                cityPricePerKm: 20,
                cityPricePerMinute: 0.8,
                minimumPrice: 80
            },
            '–ö–æ–º—Ñ–æ—Ä—Ç+': {
                boardingFee: 100,
                cityPricePerKm: 25,
                cityPricePerMinute: 1.0,
                minimumPrice: 100
            },
            '–ë–∏–∑–Ω–µ—Å': {
                boardingFee: 150,
                cityPricePerKm: 35,
                cityPricePerMinute: 1.5,
                minimumPrice: 150
            },
            '–ü—Ä–µ–º–∏—É–º': {
                boardingFee: 200,
                cityPricePerKm: 45,
                cityPricePerMinute: 2.0,
                minimumPrice: 200
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS
        function initMap() {
            try {
                console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ 2GIS
                if (typeof mapgl === 'undefined') {
                    console.error('‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 2GIS MapGL –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                const apiKey = '{{ twogis_api_key or "" }}';
                console.log('üîë API –∫–ª—é—á –¥–ª—è –∫–∞—Ä—Ç—ã:', apiKey);
                
                if (!apiKey || apiKey.trim() === '') {
                    console.error('‚ùå API –∫–ª—é—á 2GIS –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ —à–∞–±–ª–æ–Ω!');
                    return;
                }
                
                map = new mapgl.Map('map', {
                    center: [72.8019, 40.5138], // –û—à, –ö–∏—Ä–≥–∏–∑–∏—è
                    zoom: 12,
                    key: apiKey // API –∫–ª—é—á –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                });
                
                console.log('‚úÖ –ö–∞—Ä—Ç–∞ 2GIS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.on('click', function(e) {
                    const coords = e.lngLat;
                    console.log('üìç –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ:', coords);
                        
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é —Ç–æ—á–∫—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                    if (!originCoords) {
                            setMarkerByClick(coords, 'origin');
                    } else if (!destinationCoords) {
                            setMarkerByClick(coords, 'destination');
                    } else {
                        // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (confirm('–û–±–µ —Ç–æ—á–∫–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –û—á–∏—Å—Ç–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç–æ—á–∫—É –ê?')) {
                            clearMarkers();
                            setMarkerByClick(coords, 'origin');
                        }
                    }
                });

                // –û—Ç–∫–ª—é—á–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö alert'–æ–≤
                map.on('dblclick', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                // map.addControl(new mapgl.NavigationControl()); // –£–¥–∞–ª–µ–Ω NavigationControl
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        function clearMarkers() {
            if (originMarker) {
                originMarker.destroy();
                originMarker = null;
            }
            if (destinationMarker) {
                destinationMarker.destroy();
                destinationMarker = null;
            }
            if (routeLayer) {
                routeLayer.destroy();
                routeLayer = null;
            }
            originCoords = null;
            destinationCoords = null;
            distance = 0;
            duration = 0;
            
            $('#origin-address').val('');
            $('#destination-address').val('');
            $('#distance').val('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º');
            $('#duration').val('–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: 0 –º–∏–Ω');
            $('#price').val('–°—Ç–æ–∏–º–æ—Å—Ç—å: 0 —Å–æ–º');
            $('#calculated-price').val('0');
            $('#boarding-fee').val('–ü–æ—Å–∞–¥–∫–∞: 0 —Å–æ–º');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ 2GIS API
        async function geocodeAddress(address) {
            try {
                console.log('üîç –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞:', address);
                
                const response = await fetch(`/api/twogis/geocode?address=${encodeURIComponent(address)}&region=kg`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('‚úÖ –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω:', data.data);
                    return data.data;
                } else {
                    console.log('‚ùå –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º
        async function searchAddresses(query) {
            try {
                if (query.length < 3) return [];
                
                const response = await fetch(`/api/twogis/search?query=${encodeURIComponent(query)}&limit=5&region=kg`);
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    return [];
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤:', error);
                return [];
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ 2GIS API
        async function getRouteFromAPI(origin, destination) {
            try {
                console.log('üó∫Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ 2GIS API...');
                
                const response = await fetch('/api/twogis/route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'origin_lat': origin[1],
                        'origin_lon': origin[0],
                        'destination_lat': destination[1],
                        'destination_lon': destination[0],
                        'transport_type': 'car'
                    })
                });
            
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ–ª—É—á–µ–Ω:', data.data);
                    return data.data;
                } else {
                    console.log('‚ùå –ú–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∞–¥—Ä–µ—Å—É
        async function setMarkerByAddress(address, type) {
            try {
                console.log(`üîç –ü–æ–∏—Å–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∞–¥—Ä–µ—Å–∞ (${type}):`, address);
                
                const geocodeResult = await geocodeAddress(address);
                if (geocodeResult) {
                    const coords = [geocodeResult.lon, geocodeResult.lat];
                    
            if (type === 'origin') {
                        originCoords = coords;
                        if (originMarker) originMarker.destroy();
                
                originMarker = new mapgl.Marker(map, {
                            coordinates: coords,
                    icon: {
                        type: 'pin',
                        color: '#FF4444',
                        size: 'large'
                    }
                });
                
                        $('#origin-address').val(geocodeResult.address);
                        console.log('‚úÖ –¢–æ—á–∫–∞ –ê —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É');
                        
            } else if (type === 'destination') {
                        destinationCoords = coords;
                        if (destinationMarker) destinationMarker.destroy();
                
                destinationMarker = new mapgl.Marker(map, {
                            coordinates: coords,
                    icon: {
                        type: 'pin',
                        color: '#44FF44',
                        size: 'large'
                    }
                });
                
                        $('#destination-address').val(geocodeResult.address);
                        console.log('‚úÖ –¢–æ—á–∫–∞ –ë —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É');
            }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                    if (originCoords && destinationCoords) {
                calculateRoute();
            }
                    
                    return true;
                } else {
                    console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∞–¥—Ä–µ—Å–∞');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∞–¥—Ä–µ—Å—É:', error);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
        function setMarkerByClick(coords, type) {
            const lng = coords.getLng();
            const lat = coords.getLat();
            
            console.log('üìç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–∞', type, '–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º:', lat, lng);
            
                    if (type === 'origin') {
                if (originMarker) originMarker.destroy();
                    
                originCoords = [lng, lat];
                    originMarker = new mapgl.Marker(map, {
                        coordinates: originCoords,
                        icon: {
                            type: 'pin',
                            color: '#FF4444',
                            size: 'large'
                        }
                    });
                    
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                reverseGeocode(lat, lng, 'origin');
                console.log('‚úÖ –¢–æ—á–∫–∞ –ê —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                        
                    } else if (type === 'destination') {
                if (destinationMarker) destinationMarker.destroy();
                    
                destinationCoords = [lng, lat];
                    destinationMarker = new mapgl.Marker(map, {
                        coordinates: destinationCoords,
                        icon: {
                            type: 'pin',
                            color: '#44FF44',
                            size: 'large'
                        }
                    });
                    
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                reverseGeocode(lat, lng, 'destination');
                console.log('‚úÖ –¢–æ—á–∫–∞ –ë —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                }
                
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                if (originCoords && destinationCoords) {
                        calculateRoute();
                }
        }

        // –û–±—Ä–∞—Ç–Ω–∞—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∫–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –∞–¥—Ä–µ—Å)
        async function reverseGeocode(lat, lon, type) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–∫ –∞–¥—Ä–µ—Å
                const address = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                
                if (type === 'origin') {
                    $('#origin-address').val(address);
                } else if (type === 'destination') {
                    $('#destination-address').val(address);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∫–∏:', error);
            }
        }

        // –†–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ 2GIS API
        async function calculateRoute() {
            try {
                console.log('üó∫Ô∏è –†–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ 2GIS API...');
            
                if (!originCoords || !destinationCoords) {
                    console.log('‚ùå –ù–µ –∑–∞–¥–∞–Ω—ã –Ω–∞—á–∞–ª—å–Ω–∞—è –∏–ª–∏ –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞');
                return;
            }
            
                // –ü–æ–ª—É—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ API
                const routeData = await getRouteFromAPI(originCoords, destinationCoords);
                
                if (routeData) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–µ
                    distance = routeData.distance / 1000; // –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –∫–∏–ª–æ–º–µ—Ç—Ä—ã
                    duration = routeData.duration / 60;   // –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –º–∏–Ω—É—Ç—ã
                    
                    console.log('üìè –ú–∞—Ä—à—Ä—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω:', {
                        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º',
                        –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω',
                        —Ç–∏–ø_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: routeData.transport_type || '–∞–≤—Ç–æ–º–æ–±–∏–ª—å'
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    $('#distance').val(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`);
                    $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω`);
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    const calculatedPrice = calculatePrice();
                    console.log('üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞:', calculatedPrice + ' —Å–æ–º');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞
                    if (routeLayer) {
                        routeLayer.destroy();
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—è –º–∞—Ä—à—Ä—É—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
                    if (routeData.geometry && routeData.geometry.coordinates) {
                        routeLayer = new mapgl.Polyline(map, {
                            coordinates: routeData.geometry.coordinates,
                            color: '#2196F3',
                            width: 6
                        });
                        console.log('üéØ –ú–∞—Ä—à—Ä—É—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏–∏ 2GIS');
                    } else {
                        // –ò–Ω–∞—á–µ —Ä–∏—Å—É–µ–º –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é
                    routeLayer = new mapgl.Polyline(map, {
                        coordinates: [originCoords, destinationCoords],
                        color: '#00FFFC',
                        width: 5
                    });
                        console.log('‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–µ–π (–Ω–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏–∏)');
                    }
                    
                    // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –º–∞—Ä—à—Ä—É—Ç
                    const bounds = [
                        [Math.min(originCoords[0], destinationCoords[0]), Math.min(originCoords[1], destinationCoords[1])],
                        [Math.max(originCoords[0], destinationCoords[0]), Math.max(originCoords[1], destinationCoords[1])]
                    ];
                    map.fitBounds(bounds, { padding: 50 });
                    
                    console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ');
                    
                } else {
                    // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç
                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞');
                    calculateSimpleRoute();
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç
                calculateSimpleRoute();
            }
        }

        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ (fallback)
        function calculateSimpleRoute() {
            if (originCoords && destinationCoords) {
                // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –ø–æ –ø—Ä—è–º–æ–π
                distance = calculateDistance(originCoords[1], originCoords[0], destinationCoords[1], destinationCoords[0]);
                // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö (—Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å 30 –∫–º/—á –≤ –≥–æ—Ä–æ–¥–µ)
                duration = (distance / 30) * 60;
                
                console.log('üìè –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞:', {
                    —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º (–ø–æ –ø—Ä—è–º–æ–π)',
                    –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω (–ø—Ä–∏–º–µ—Ä–Ω–æ)',
                    —Å–∫–æ—Ä–æ—Å—Ç—å: '30 –∫–º/—á (–≥–æ—Ä–æ–¥—Å–∫–∞—è)'
                });
                
                $('#distance').val(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º (–ø–æ –ø—Ä—è–º–æ–π)`);
                $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω (–ø—Ä–∏–º–µ—Ä–Ω–æ)`);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                const calculatedPrice = calculatePrice();
                console.log('üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ (–ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç):', calculatedPrice + ' —Å–æ–º');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é
                if (routeLayer) {
                    routeLayer.destroy();
                }
                
                routeLayer = new mapgl.Polyline(map, {
                    coordinates: [originCoords, destinationCoords],
                    color: '#2196F3',
                    width: 5
                });
                
                console.log('‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç)');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('üí∞ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ç–∞—Ä–∏—Ñ–æ–≤:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
                $('#tariff-display').val(tariff);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏
                if (distance > 0 && duration > 0) {
                    const pricePerKm = tariffData.cityPricePerKm;
                    const pricePerMinute = tariffData.cityPricePerMinute;
                    
                    const distancePrice = distance * pricePerKm;
                    const timePrice = duration * pricePerMinute;
                    
                    price += distancePrice + timePrice;
                    
                    console.log('üìä –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:', {
                        –ø–æ—Å–∞–¥–∫–∞: tariffData.boardingFee + ' —Å–æ–º',
                        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance.toFixed(1) + ' –∫–º √ó ' + pricePerKm + ' —Å–æ–º/–∫–º = ' + distancePrice.toFixed(0) + ' —Å–æ–º',
                        –≤—Ä–µ–º—è: duration.toFixed(0) + ' –º–∏–Ω √ó ' + pricePerMinute + ' —Å–æ–º/–º–∏–Ω = ' + timePrice.toFixed(0) + ' —Å–æ–º',
                        –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è_—Å—É–º–º–∞: (tariffData.boardingFee + distancePrice + timePrice).toFixed(0) + ' —Å–æ–º'
                    });
                } else {
                    console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–∞–¥–∫–∏');
                    if (distance <= 0) {
                        $('#distance').val('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ');
                    }
                    if (duration <= 0) {
                        $('#duration').val('–í—Ä–µ–º—è –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ');
                    }
                }
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –±–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å–∞
                if (tariff === '–ë–∏–∑–Ω–µ—Å' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                    console.log('üè¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –±–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å–∞:', tariffData.minimumPrice + ' —Å–æ–º');
                }
                
                // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞
                price = Math.ceil(price);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                $('#price').val(`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} —Å–æ–º`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`–ü–æ—Å–∞–¥–∫–∞: ${tariffData.boardingFee} —Å–æ–º`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—É—Ç–∏
                if (duration > 0) {
                    $('#duration').val(`–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${duration.toFixed(0)} –º–∏–Ω`);
                }
                
                console.log('‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏:', {
                    —Ç–∞—Ä–∏—Ñ: tariff,
                    —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: distance > 0 ? distance.toFixed(1) + ' –∫–º' : '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ',
                    –≤—Ä–µ–º—è: duration > 0 ? duration.toFixed(0) + ' –º–∏–Ω' : '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ',
                    —Å—Ç–æ–∏–º–æ—Å—Ç—å_–ø–æ—Å–∞–¥–∫–∏: tariffData.boardingFee + ' —Å–æ–º',
                    –∏—Ç–æ–≥–æ–≤–∞—è_—Ü–µ–Ω–∞: price + ' —Å–æ–º'
                });
                
                return price;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏:', error);
                $('#price').val('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
                return 0;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        $(window).on('load', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
            setTimeout(function() {
                try {
                    initMap();
                    console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
                }
            }, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
            try {
                const tariff = $(this).val();
                console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–∞:', error);
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        $('#origin-address, #destination-address').on('change keyup', function() {
            const fieldId = $(this).attr('id');
            const address = $(this).val().trim();
            console.log('–ò–∑–º–µ–Ω–µ–Ω –∞–¥—Ä–µ—Å –≤ –ø–æ–ª–µ:', fieldId, '‚Üí', address);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
            if (address.length > 2) {
                const type = fieldId.includes('origin') ? 'origin' : 'destination';
                console.log('üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è:', type);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ
                clearTimeout(window.addressTimeout);
                window.addressTimeout = setTimeout(function() {
                    setMarkerByAddress(address, type);
                }, 800); // 800–º—Å –∑–∞–¥–µ—Ä–∂–∫–∞
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª–µ–π –∞–¥—Ä–µ—Å–æ–≤
        function initAutocomplete() {
            $('#origin-address, #destination-address').each(function() {
                const $input = $(this);
                const $container = $input.parent();
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                if (!$container.find('.autocomplete-dropdown').length) {
                    $container.css('position', 'relative');
                    $container.append('<div class="autocomplete-dropdown"></div>');
                }
                
                const $dropdown = $container.find('.autocomplete-dropdown');
                
                $input.on('input', function() {
                    const value = $(this).val().toLowerCase().trim();
                    $dropdown.empty().hide();
                    
                    if (value.length >= 2) {
                        searchAddresses(value).then(addresses => {
                            if (addresses.length > 0) {
                                addresses.forEach(address => {
                                    const $item = $('<div class="autocomplete-item">' + address.name + '</div>');
                                $item.on('click', function() {
                                        $input.val(address.name);
                                    $dropdown.hide();
                                        console.log('‚úÖ –í—ã–±—Ä–∞–Ω –∞–¥—Ä–µ—Å –∏–∑ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:', address.name);
                                    
                                    // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ —Å–ø–∏—Å–∫–∞
                                    const type = $input.attr('id').includes('origin') ? 'origin' : 'destination';
                                    console.log('üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞:', type);
                                        setMarkerByAddress(address.name, type);
                                });
                                $dropdown.append($item);
                            });
                            $dropdown.show();
                        }
                        });
                    }
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                $(document).on('click', function(e) {
                    if (!$container.is(e.target) && !$container.has(e.target).length) {
                        $dropdown.hide();
                    }
                });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(initAutocomplete, 500);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –ö–∏—Ä–≥–∏–∑–∏–∏ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ (–¥–µ–ª–∞–µ–º –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–æ–π)
        $('#origin-address, #destination-address').on('blur', function() {
            const address = $(this).val().toLowerCase().trim();
            // –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–≥—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ —á—Ç–æ-—Ç–æ
            if (address && address.length > 2) {
                if (!isKyrgyzstanAddress(address)) {
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    console.warn('–í–≤–µ–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –ö–∏—Ä–≥–∏–∑–∏–∏:', address);
                }
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∞–¥—Ä–µ—Å –∫ –ö–∏—Ä–≥–∏–∑–∏–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function isKyrgyzstanAddress(address) {
            const kyrgyzstanKeywords = [
                '–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω', '–∫–∏—Ä–≥–∏–∑–∏—è', '–±–∏—à–∫–µ–∫', '–æ—à', '–¥–∂–∞–ª–∞–ª-–∞–±–∞–¥', '–¥–∂–∞–ª–∞–ª–∞–±–∞–¥',
                '–∫–∞—Ä–∞–∫–æ–ª', '–Ω–∞—Ä—ã–Ω', '—Ç–∞–ª–∞—Å', '–±–∞—Ç–∫–µ–Ω', '—á—É–π', '–∏—Å—Å—ã–∫-–∫—É–ª—å', '–∏—Å—ã–∫–∫—É–ª—å',
                '–∫–≥', 'kg', 'bishkek', 'osh', 'jalal-abad', 'karakol', 
                'naryn', 'talas', 'batken', '—á–æ–ª–ø–æ–Ω-–∞—Ç–∞', '–∫–µ—Ä–±–µ–Ω', '—Ç–æ–∫–º–∞–∫',
                '–∫–∞–Ω—Ç', '—Å–æ–∫—É–ª—É–∫', '–±–µ–ª–æ–≤–æ–¥—Å–∫–æ–µ', '–∫–µ–º–∏–Ω', '—á–æ–ª–ø–æ–Ω', '–∞—Ç–∞',
                '–∫–æ—á–∫–æ—Ä', '–∞—Ç-–±–∞—à—ã', '–∫—ã–∑—ã–ª-–∫–∏—è', '—Å—É–ª—é–∫—Ç–∞', '—É–∑–≥–µ–Ω',
                '–∞—Ä—Å–ª–∞–Ω–±–æ–±', '–º–∞–π–ª—É—É-—Å—É—É', '–∂–∞–ª–∞–ª-–∞–±–∞–¥', '–∫–∞–π—ã–Ω–¥—ã', '–±–∞–∑–∞—Ä-–∫–æ—Ä–≥–æ–Ω',
                '–Ω–æ–æ–∫–∞—Ç', '–∫–∞—Ä–∞-—Å—É—É', '–∫–∞—Ä–∞-–∫—É–ª–∂–∞', '–ª–µ–Ω–∏–Ω', '–ø–∏–∫', '–ª–µ–Ω–∏–Ω–∞'
            ];
            
            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ - —Å—á–∏—Ç–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–º
            // –ò–ª–∏ –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã - —Ç–æ–∂–µ –≤–∞–ª–∏–¥–Ω—ã–º
            return kyrgyzstanKeywords.some(keyword => address.includes(keyword)) || 
                   /^[\d\.,\s\-]+$/.test(address); // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–ª–∏ —á–∏—Å–ª–∞
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            
            if (!driverId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
                return false;
            }
            if (!tariff) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
                return false;
            }
            if (!paymentMethod) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
                return false;
            }
            if (!origin) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
                return false;
            }
            if (!destination) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥—Ä–µ—Å–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ö–∏—Ä–≥–∏–∑–∏–∏ (–¥–µ–ª–∞–µ–º –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∏–º)
            if (!isKyrgyzstanAddress(origin.toLowerCase())) {
                console.warn('–í–Ω–∏–º–∞–Ω–∏–µ: –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –ö–∏—Ä–≥–∏–∑–∏–∏');
                // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
            }
            if (!isKyrgyzstanAddress(destination.toLowerCase())) {
                console.warn('–í–Ω–∏–º–∞–Ω–∏–µ: –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –ö–∏—Ä–≥–∏–∑–∏–∏');
                // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
            }
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function(response) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    window.location.href = '/disp/';
                },
                error: function(error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (error.responseJSON ? error.responseJSON.detail : '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º'));
                }
            });
        });
        
        // –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞
        $('#cancel-btn').click(function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?')) {
                window.location.href = '/disp/';
            }
        });
        
        // –ù–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏ F2 –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2 key
                e.preventDefault();
                window.location.reload();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã"
        $('#clear-markers-btn').click(function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–æ–ª—è –∞–¥—Ä–µ—Å–æ–≤?')) {
                clearMarkers();
                console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã, –∫–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é');
            }
        });
    } // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ initApp
</script>
<style>
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .main__order-wrapper {
        border-radius: 5px;
    }
    .main__order-header {
        flex-wrap: wrap;
    }
    .main__btn {
        padding: 12px 30px;
    }
    .main__order-subheader {
        gap: 20px;
        flex-wrap: wrap;
    }
    .main__order-subheader-item {
        width: 100%;
    } 
    .main__subheader-filing {
        width: 100%;
    }
    #tariff-select,
    #payment-method {
        width: 100%;
    }
    .main__order-subheader-item .main__btn-short {
        width: 100%;
    }
    .main__order-notes {
        width: 100%;
        display: flex;
        justify-content: space-between;
    } 
    .main__order-notes-text {
        width: 65%;
    }
    @media (max-width: 1200px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        .main__order-settings, .main__order-map {
            width: 100%;
            margin-bottom: 20px;
        }
        .main__header-tags ul li {
            padding: 10px 15px;
        }
    }
    
    @media (max-width: 768px) {
        .main__header {
            flex-direction: column;
            align-items: flex-start;
        }
        .main__header-logo, .main__header-tags, .main__header-search {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__subheader-add {
            flex-wrap: wrap;
        }
        .main__order-header, .main__order-subheader {
            flex-direction: column;
        }
        .main__order-header-item, .main__order-subheader-item {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-details-item {
            flex-direction: column;
        }
        .main__order-details-item input {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-map-item {
            height: 300px;
        }
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∏–ª–µ–π */
    .main__order-map-item {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main__btn, .main__btn-short, .main__btn-green {
        transition: all 0.3s ease;
    }
    
    .main__btn:hover, .main__btn-short:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__btn-green:hover {
        background-color: #35a63a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__order-notes-text textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        resize: vertical;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∞ */
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .route-info-item {
        background-color: #47484c;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .route-info-item input {
        width: 90%;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #2d2e33;
        border: 1px solid #47484c;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        color: #fff;
        border-bottom: 1px solid #47484c;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #47484c;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–æ–≤ */
    .main__order-details-item {
        position: relative;
    }
    
    @media (max-width: 576px) {
        .route-info-item {
            width: 100%;
        }
    }
</style>
{% endblock %}